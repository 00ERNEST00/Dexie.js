!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):(e.Dexie=e.Dexie||{},e.Dexie.Observable=n(e.Dexie))}(this,function(e){"use strict";function n(u){function l(t){n.latestRevision[u.name]<t&&(n.latestRevision[u.name]=t,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(u.name,t)}),T&&T.setItem("Dexie.Observable/latestRevision/"+u.name,t))}function d(t){if(!t.hook._observing){t.hook._observing=!0;var i=t.name;t.hook("creating").subscribe(function(r,o,a){var s=void 0;void 0===r&&t.schema.primKey.uuid&&(r=s=n.createUUID(),t.schema.primKey.keyPath&&e.setByKeyPath(o,t.schema.primKey.keyPath,r));var c={source:a.source||null,table:i,key:void 0===r?null:r,type:N,obj:o},l=u._changes.add(c).then(function(e){return a._lastWrittenRevision=Math.max(a._lastWrittenRevision,e),e});return this.onsuccess=function(e){r!=e&&l._then(function(){c.key=e,u._changes.put(c)})},this.onerror=function(e){l._then(function(e){u._changes.delete(e)})},s}),t.hook("updating").subscribe(function(n,t,r,o){var a={},s=!1,c=e.deepClone(r);for(var l in n){var d=n[l];if("undefined"==typeof d)e.delByKeyPath(c,l),a[l]=null,s=!0;else{var f=e.getByKeyPath(r,l);d!==f&&JSON.stringify(d)!==JSON.stringify(f)&&(e.setByKeyPath(c,l,d),a[l]=d,s=!0)}}if(s){var m={source:o.source||null,table:i,key:t,type:O,mods:a,oldObj:r,obj:c},v=u._changes.add(m);this.onsuccess=function(){v._then(function(e){o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e)})},this.onerror=function(e){v._then(function(e){u._changes.delete(e)})}}}),t.hook("deleting").subscribe(function(e,n,t){var r=u._changes.add({source:t.source||null,table:i,key:e,type:S,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});this.onerror=function(){r._then(function(e){u._changes.delete(e)})}})}}function f(n,t){if(n===u.name){if(B>=t)return;B=t,e.vip(function(){m(t).catch("DatabaseClosedError",function(e){})})}}function m(t,i,o){if(!i&&m.ongoingOperation)return m.ongoingOperation;var a=!1,l=C;if(!l)return s.reject(new e.DatabaseClosedError);var d=1e3,f=u._changes.where("rev").above(l.myRevision).limit(d).toArray(function(e){if(e.length>0){var n=e[e.length-1];a=e.length===d,u.on("changes").fire(e,a),l.myRevision=n.rev}else o&&u.on("changes").fire([],!1);var t=!1;return u._syncNodes.where(":id").equals(l.id).modify(function(e){t=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,l.myRevision)}).then(function(){return t})}).then(function(e){if(!e)throw c?new Error("Browser is shutting down"):(u.close(),console.error("Out of sync"),r.location&&r.location.reload(!0),new Error("Out of sync"));if(a||n.latestRevision[u.name]>l.myRevision)return m(n.latestRevision[u.name],(i||0)+1,a)}).finally(function(){delete m.ongoingOperation});return i||(m.ongoingOperation=f),f}function v(){j=null;var t=C&&C.id;t&&e.vip(function(){m(n.latestRevision[u.name]).then(y).then(b).catch("DatabaseClosedError",function(e){}).finally(function(){C&&C.id===t&&(j=setTimeout(v,w))})})}function y(){var t=C;return t?u.transaction("rw","_syncNodes","_changes","_intercomm",function(){var e=!1;u._syncNodes.where("lastHeartBeat").below(Date.now()-x).filter(function(e){return"local"===e.type}).modify(function(n){n.deleteTimeStamp&&n.deleteTimeStamp<Date.now()?(delete this.value,T&&T.removeItem("Dexie.Observable/deadnode:"+n.id+"/"+u.name),n.isMaster&&(u._syncNodes.update(t,{isMaster:1}),e=!0),u._intercomm.where({destinationNode:n.id}).modify(function(e){e.wantReply?e.destinationNode=t.id:delete this.value})):n.deleteTimeStamp||(n.deleteTimeStamp=Date.now()+R)}).then(function(){return n.deleteOldChanges(u),u.on("cleanup").fire(e)})}):s.reject(new e.DatabaseClosedError)}function p(e){C&&(c=!0,C.deleteTimeStamp=1,C.lastHeartBeat=0,u._syncNodes.put(C),n.wereTheOneDying=!0,T&&T.setItem("Dexie.Observable/deadnode:"+C.id.toString()+"/"+u.name,"dead"))}function h(t,i){t!==u.name||n.wereTheOneDying||e.vip(function(){u._syncNodes.update(i,{deleteTimeStamp:1,lastHeartBeat:0}).then(y)})}function b(){return C?e.ignoreTransaction(function(){return u._intercomm.where({destinationNode:C.id}).toArray(function(e){return e.forEach(function(e){return g(e)}),u._intercomm.where("id").anyOf(e.map(function(e){return e.id})).delete()})}):s.reject(new e.DatabaseClosedError)}function g(n){if("response"===n.type){var t=M[n.requestId.toString()];t&&(n.isFailure?t.reject(n.message.error):t.resolve(n.message.result),delete M[n.requestId.toString()])}else{n.resolve=function(e){u.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){u.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})};var i=n.message;delete n.message,e.extend(n,i),u.on.message.fire(n)}}function _(e){e===u.name&&b().catch("DatabaseClosedError",function(){})}var x=2e4,R=2e4,w=2e3,N=1,O=2,S=3,T=n.localStorageImpl,D=e.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}}),C=null;Object.defineProperty(u,"_localSyncNode",{get:function(){return C}});var j=null;e.fake&&(u.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),u._syncNodes.mapToClass(D),u._changes.mapToClass(o),C=new D({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),u.Version.prototype._parseStoresSpec=a(u.Version.prototype._parseStoresSpec,function(e){return function(n,t){n._changes="++rev",n._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",n._intercomm="++id,destinationNode",n._uncommittedChanges="++id,node",e.call(this,n,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}),u.on.addEventType({changes:"asap",cleanup:[i,t],message:"asap"}),u._createTransaction=a(u._createTransaction,function(e){return function(n,t,i,r){if(u.dynamicallyOpened())return e.apply(this,arguments);var o=!1;"readwrite"===n&&t.some(function(e){return i[e]&&i[e].observable})&&(o=!0,t=t.slice(0),t.indexOf("_changes")===-1&&t.push("_changes"));var a=e.call(this,n,t,i,r);return o&&(a._lastWrittenRevision=0,a.on("complete",function(){if(a._lastWrittenRevision)if(r){var e=function e(n){return n.parent?e(n.parent):n}(r);e._lastWrittenRevision=Math.max(a._lastWrittenRevision,e.lastWrittenRevision||0)}else l.timeoutHandle&&clearTimeout(l.timeoutHandle),l.timeoutHandle=setTimeout(function(){delete l.timeoutHandle,l(a._lastWrittenRevision)},25)}),a.parent&&a.parent.source&&(a.source=a.parent.source)),a}}),n.latestRevision[u.name]=n.latestRevision[u.name]||0,u.open=a(u.open,function(e){return function(){return Object.keys(u._allTables).forEach(function(e){var n=u._allTables[e];n.schema.observable&&d(n),"_syncNodes"===n.name&&n.mapToClass(D)}),e.apply(this,arguments)}}),u.close=a(u.close,function(e){return function(){return u.dynamicallyOpened()?e.apply(this,arguments):(l.timeoutHandle&&(clearTimeout(l.timeoutHandle),delete l.timeoutHandle),n.on("latestRevisionIncremented").unsubscribe(f),n.on("suicideNurseCall").unsubscribe(h),n.on("intercomm").unsubscribe(_),n.on("beforeunload").unsubscribe(p),C&&C.id&&(n.on.suicideNurseCall.fire(u.name,C.id),T&&T.setItem("Dexie.Observable/deadnode:"+C.id.toString()+"/"+u.name,"dead"),C.deleteTimeStamp=1,C.lastHeartBeat=0,u._syncNodes.put(C),C=null),j&&clearTimeout(j),j=null,e.apply(this,arguments))}}),u.delete=a(u.delete,function(e){return function(){return e.apply(this,arguments).then(function(e){return n.latestRevision[u.name]=0,e})}}),u.on("ready",function(){return u.dynamicallyOpened()?u:u.table("_changes").orderBy("rev").last(function(t){var i=t?t.rev:0;return C=new D({myRevision:i,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),n.latestRevision[u.name]<i&&(n.latestRevision[u.name]=i,e.ignoreTransaction(function(){n.on.latestRevisionIncremented.fire(i)})),u.transaction("rw","_syncNodes",function(){return u._syncNodes.where("isMaster").equals(1).first(function(e){if(e){if(e.lastHeartBeat<Date.now()-x)return C.isMaster=1,e.isMaster=0,u._syncNodes.put(e)}else C.isMaster=1}).then(function(){return u._syncNodes.add(C).then(function(){n.on("latestRevisionIncremented",f),n.on("beforeunload",p),n.on("suicideNurseCall",h),n.on("intercomm",_),j=setTimeout(v,w)})})}).then(function(){y()})})},!0);var B=0,M={};u.sendMessage=function(t,i,r,o){o=o||{};var a={message:i,destinationNode:r,sender:C.id,type:t};return e.extend(a,o),C?e.ignoreTransaction(function(){var e=["_intercomm"];o.wantReply&&e.push("_syncNodes");var t=u.transaction("rw",e,function(){return o.wantReply?u._syncNodes.where("id").equals(r).count(function(e){return e?u._intercomm.add(a):u._syncNodes.where("isMaster").above(0).first(function(e){return a.destinationNode=e.id,u._intercomm.add(a)})}):u._intercomm.add(a)}).then(function(e){var t=null;return o.wantReply&&(t=new s(function(n,t){M[e.toString()]={resolve:n,reject:t}})),T&&T.setItem("Dexie.Observable/intercomm/"+u.name,e.toString()),n.on.intercomm.fire(u.name),t});return o.wantReply?t:void t.catch(function(){})}):o.wantReply?s.reject(new e.DatabaseClosedError):s.resolve()},u.broadcastMessage=function(n,t,i){if(C){var r=C.id;e.ignoreTransaction(function(){u._syncNodes.toArray(function(e){return s.all(e.filter(function(e){return"local"===e.type&&(i||e.id!==r)}).map(function(e){return u.sendMessage(n,t,e.id)}))}).catch(function(){})})}},u.observable={},u.observable.SyncNode=D}function t(){}function i(e,n){return e===t?n:function(){var t=e.apply(this,arguments);if(t&&"function"==typeof t.then){var i=this,r=arguments;return t.then(function(){return n.apply(i,r)})}return n.apply(this,arguments)}}e="default"in e?e.default:e;var r=self,o=e.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),a=e.override,s=e.Promise,c=!1;n.latestRevision={},n.on=e.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),n.createUUID=function(){var e=Date.now(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?t:7&t|8).toString(16)});return n},n.deleteOldChanges=function(t){var i=100;e.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(i).primaryKeys()}).then(function(e){if(0!==e.length)return t._changes.bulkDelete(e).then(function(){e.length===i&&setTimeout(function(){return t.isOpen()&&n.deleteOldChanges(t)},500)})})}).catch(function(){})},n._onStorage=function(t){if(0===t.key.indexOf("Dexie.Observable/")){var i=t.key.split("/"),r=i[1],o=i[2];if("latestRevision"===r){var a=parseInt(t.newValue,10);!isNaN(a)&&a>n.latestRevision[o]&&(n.latestRevision[o]=a,e.ignoreTransaction(function(){n.on("latestRevisionIncremented").fire(o,a)}))}else if(0===r.indexOf("deadnode:")){var s=parseInt(r.split(":")[1],10);t.newValue&&n.on.suicideNurseCall.fire(o,s)}else"intercomm"===r&&t.newValue&&n.on.intercomm.fire(o)}},n._onBeforeUnload=function(){n.on.beforeunload.fire()};try{n.localStorageImpl=r.localStorage}catch(e){}return r.addEventListener&&(r.addEventListener("storage",n._onStorage),r.addEventListener("beforeunload",n._onBeforeUnload)),e.Observable=n,e.addons.push(n),n});
//# sourceMappingURL=dexie-observable.min.js.map