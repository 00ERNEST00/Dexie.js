!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("dexie")):"function"==typeof define&&define.amd?define(["dexie"],n):(e.Dexie=e.Dexie||{},e.Dexie.Observable=n(e.Dexie))}(this,function(B){"use strict";function k(){}function E(o,i){return o===k?i:function(){var e=o.apply(this,arguments);if(e&&"function"==typeof e.then){var n=this,t=arguments;return e.then(function(){return i.apply(n,t)})}return i.apply(this,arguments)}}function c(){var t=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:7&n|8).toString(16)})}B=B&&B.hasOwnProperty("default")?B.default:B;var u=1,v=2,l=3;function H(t){return function(e){if(!e.hook._observing){e.hook._observing=!0;var a,s,f,m,i,r,n=e.name;e.hook("creating").subscribe((a=t,s=e,function(n,e,t){var o=void 0;void 0===n&&s.schema.primKey.uuid&&(n=o=c(),s.schema.primKey.keyPath&&B.setByKeyPath(e,s.schema.primKey.keyPath,n));var i={source:t.source||null,table:s.name,key:void 0===n?null:n,type:u,obj:e},r=a._changes.add(i).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e});return this.onsuccess=function(e){n!=e&&r._then(function(){i.key=e,a._changes.put(i)})},this.onerror=function(){r._then(function(e){a._changes.delete(e)})},o})),e.hook("updating").subscribe((f=t,m=n,function(e,n,t,o){var i={},r=!1,a=B.deepClone(t);for(var s in e){var c=e[s];if(void 0===c)B.delByKeyPath(a,s),r=!(i[s]=null);else{var u=B.getByKeyPath(t,s);c!==u&&JSON.stringify(c)!==JSON.stringify(u)&&(B.setByKeyPath(a,s,c),i[s]=c,r=!0)}}if(r){var l={source:o.source||null,table:m,key:n,type:v,mods:i,oldObj:t,obj:a},d=f._changes.add(l);this.onsuccess=function(){d._then(function(e){o._lastWrittenRevision=Math.max(o._lastWrittenRevision,e)})},this.onerror=function(){d._then(function(e){f._changes.delete(e)})}}})),e.hook("deleting").subscribe((i=t,r=n,function(e,n,t){var o=i._changes.add({source:t.source||null,table:r,key:e,type:l,oldObj:n}).then(function(e){return t._lastWrittenRevision=Math.max(t._lastWrittenRevision,e),e}).catch(function(e){console.log(n),console.log(e.stack)});this.onerror=function(){o._then(function(e){i._changes.delete(e)})}}))}}}var d=B.Promise;function K(r,a,e,s,c){var u={};function n(){return s.node?B.ignoreTransaction(function(){return r.transaction("rw","_intercomm",function(){return r._intercomm.where({destinationNode:s.node.id}).toArray(function(e){return e.forEach(function(e){return function(n){if("response"===n.type){var e=u[n.requestId.toString()];e&&(n.isFailure?e.reject(n.message.error):e.resolve(n.message.result),delete u[n.requestId.toString()])}else n.resolve=function(e){r.observable.sendMessage("response",{result:e},n.sender,{requestId:n.id})},n.reject=function(e){r.observable.sendMessage("response",{error:e.toString()},n.sender,{isFailure:!0,requestId:n.id})},r.on.message.fire(n)}(e)}),r._intercomm.where("id").anyOf(e.map(function(e){return e.id})).delete()})})}):d.reject(new B.DatabaseClosedError)}return r.observable.sendMessage=function(e,n,t,o){if(o=o||{},!s.node)return o.wantReply?d.reject(new B.DatabaseClosedError):d.resolve();var i={message:n,destinationNode:t,sender:s.node.id,type:e};return B.extend(i,o),B.ignoreTransaction(function(){var e=["_intercomm"];o.wantReply&&e.push("_syncNodes");var n=r.transaction("rw",e,function(){return o.wantReply?r._syncNodes.where("id").equals(t).count(function(e){return e?r._intercomm.add(i):r._syncNodes.where("isMaster").above(0).first(function(e){return i.destinationNode=e.id,r._intercomm.add(i)})}):r._intercomm.add(i)}).then(function(t){var e=null;return o.wantReply&&(e=new d(function(e,n){u[t.toString()]={resolve:e,reject:n}})),c&&c.setItem("Dexie.Observable/intercomm/"+r.name,t.toString()),a.on.intercomm.fire(r.name),e});return o.wantReply?n:void n.catch(function(){})})},r.observable.broadcastMessage=function(n,t,o){if(s.node){var i=s.node.id;B.ignoreTransaction(function(){r._syncNodes.toArray(function(e){return d.all(e.filter(function(e){return"local"===e.type&&(o||e.id!==i)}).map(function(e){return r.observable.sendMessage(n,t,e.id)}))}).catch(function(){})})}},{onIntercomm:function(e){e===r.name&&n().catch("DatabaseClosedError",function(){})},consumeIntercommMessages:n}}function P(n){return function(e,t){e._changes="++rev",e._syncNodes="++id,myRevision,lastHeartBeat,&url,isMaster,type,status",e._intercomm="++id,destinationNode",e._uncommittedChanges="++id,node",n.call(this,e,t),Object.keys(t).forEach(function(e){var n=t[e];0===n.primKey.name.indexOf("$$")&&(n.primKey.uuid=!0,n.primKey.name=n.primKey.name.substr(2),n.primKey.keyPath=n.primKey.keyPath.substr(2))}),Object.keys(t).forEach(function(e){0!==e.indexOf("_")&&0!==e.indexOf("$")&&(t[e].observable=!0)})}}var a,W=self,q=B.defineClass({rev:Number,source:String,table:String,key:Object,type:Number,obj:Object,mods:Object,oldObj:Object}),U=B.override,V=B.Promise,A=!1;function L(a){var o=2e4,i=2e4,t=500,r=o-5e3,s=L.localStorageImpl,c=B.defineClass({myRevision:Number,type:String,lastHeartBeat:Number,deleteTimeStamp:Number,url:String,isMaster:Number,syncProtocol:String,syncContext:null,syncOptions:Object,connected:!1,status:Number,appliedRemoteRevision:null,remoteBaseRevisions:[{local:Number,remote:null}],dbUploadState:{tablesToUpload:[String],currentTable:String,currentKey:null,localBaseRevision:Number}});a.observable={},a.observable.SyncNode=c;var n,u,l,d,f,m,v,y,p=(n=a,u=L,l=s,function(e){u.latestRevision[n.name]<e&&(u.latestRevision[n.name]=e,B.ignoreTransaction(function(){u.on("latestRevisionIncremented").fire(n.name,e)}),l&&l.setItem("Dexie.Observable/latestRevision/"+n.name,e))}),e=(d=a,f=p,function(a){return function(e,n,t,o){if(d.dynamicallyOpened())return a.apply(this,arguments);var i=!1;"readwrite"===e&&n.some(function(e){return t[e]&&t[e].observable})&&(i=!0,-1===(n=n.slice(0)).indexOf("_changes")&&n.push("_changes"));var r=a.call(this,e,n,t,o);return i&&(r._lastWrittenRevision=0,r.on("complete",function(){if(r._lastWrittenRevision)if(o){var e=function e(n){return n.parent?e(n.parent):n}(o);e._lastWrittenRevision=Math.max(r._lastWrittenRevision,e.lastWrittenRevision||0)}else f.timeoutHandle&&clearTimeout(f.timeoutHandle),f.timeoutHandle=setTimeout(function(){delete f.timeoutHandle,f(r._lastWrittenRevision)},25)}),r.parent&&r.parent.source&&(r.source=r.parent.source)),r}}),h=H(a),b=(m=a,v=c,y=h,function(e){return function(){return Object.keys(m._allTables).forEach(function(e){var n=m._allTables[e];n.schema.observable&&y(n),"_syncNodes"===n.name&&n.mapToClass(v)}),e.apply(this,arguments)}}),g={node:null},_=K(a,L,0,g,s),x=_.onIntercomm,R=_.consumeIntercommMessages;Object.defineProperty(a,"_localSyncNode",{get:function(){return g.node}});var w=null,N=null;B.fake&&(a.version(1).stores({_syncNodes:"++id,myRevision,lastHeartBeat",_changes:"++rev",_intercomm:"++id,destinationNode",_uncommittedChanges:"++id,node"}),a._syncNodes.mapToClass(c),a._changes.mapToClass(q),g.node=new c({myRevision:0,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null})),a.Version.prototype._parseStoresSpec=U(a.Version.prototype._parseStoresSpec,P),a.on.addEventType({changes:"asap",cleanup:[E,k],message:"asap"}),a._createTransaction=U(a._createTransaction,e),L.latestRevision[a.name]=L.latestRevision[a.name]||0,a.open=U(a.open,b),a.close=U(a.close,function(e){return function(){return a.dynamicallyOpened()||(p.timeoutHandle&&(clearTimeout(p.timeoutHandle),delete p.timeoutHandle),L.on("latestRevisionIncremented").unsubscribe(S),L.on("suicideNurseCall").unsubscribe(j),L.on("intercomm").unsubscribe(x),L.on("beforeunload").unsubscribe(M),g.node&&g.node.id&&(L.on.suicideNurseCall.fire(a.name,g.node.id),s&&s.setItem("Dexie.Observable/deadnode:"+g.node.id.toString()+"/"+a.name,"dead"),g.node.deleteTimeStamp=1,g.node.lastHeartBeat=0,a._syncNodes.put(g.node),g.node=null),w&&clearTimeout(w),w=null,N&&clearTimeout(N),N=null),e.apply(this,arguments)}}),a.delete=U(a.delete,function(e){return function(){return e.apply(this,arguments).then(function(e){return L.latestRevision[a.name]=0,e})}}),a.on("ready",function(){return a.dynamicallyOpened()?a:a.table("_changes").orderBy("rev").last(function(e){var n=e?e.rev:0;return g.node=new c({myRevision:n,type:"local",lastHeartBeat:Date.now(),deleteTimeStamp:null,isMaster:0}),L.latestRevision[a.name]<n&&(L.latestRevision[a.name]=n,B.ignoreTransaction(function(){L.on.latestRevisionIncremented.fire(n)})),a.transaction("rw","_syncNodes",function(){return a._syncNodes.where("isMaster").equals(1).first(function(e){if(e){if(e.lastHeartBeat<Date.now()-o)return g.node.isMaster=1,e.isMaster=0,a._syncNodes.put(e)}else g.node.isMaster=1}).then(function(){return a._syncNodes.add(g.node).then(function(){L.on("latestRevisionIncremented",S),L.on("beforeunload",M),L.on("suicideNurseCall",j),L.on("intercomm",x),w=setTimeout(C,t),N=setTimeout(D,r)})})}).then(function(){I()})})},!0);var O=0;function S(e,n){if(e===a.name){if(n<=O)return;O=n,B.vip(function(){T(n).catch("DatabaseClosedError",function(){})})}}function T(e,n,o){if(!n&&T.ongoingOperation)return T.ongoingOperation;var i=!1,r=g.node;if(!r)return V.reject(new B.DatabaseClosedError);var t=a._changes.where("rev").above(r.myRevision).limit(1e3).toArray(function(e){if(0<e.length){var n=e[e.length-1];i=1e3===e.length,a.on("changes").fire(e,i),r.myRevision=n.rev}else o&&a.on("changes").fire([],!1);var t=!1;return a._syncNodes.where(":id").equals(r.id).modify(function(e){t=!0,e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,e.myRevision=Math.max(e.myRevision,r.myRevision)}).then(function(){return t})}).then(function(e){if(!e)throw A?new Error("Browser is shutting down"):(a.close(),console.error("Out of sync"),W.location&&W.location.reload(!0),new Error("Out of sync"));if(i||L.latestRevision[a.name]>r.myRevision)return T(L.latestRevision[a.name],(n||0)+1,i)}).finally(function(){delete T.ongoingOperation});return n||(T.ongoingOperation=t),t}function D(){N=null;var e=g.node&&g.node.id;e&&a.transaction("rw!",a._syncNodes,function(){a._syncNodes.where({id:e}).first(function(e){if(e)return e.lastHeartBeat=Date.now(),e.deleteTimeStamp=null,a._syncNodes.put(e);a.isOpen()&&a.close()})}).catch("DatabaseClosedError",function(){}).finally(function(){g.node&&g.node.id===e&&a.isOpen()&&(N=setTimeout(D,r))})}function C(){w=null;var e=g.node&&g.node.id;e&&B.vip(function(){T(L.latestRevision[a.name]).then(I).then(R).catch("DatabaseClosedError",function(){}).finally(function(){g.node&&g.node.id===e&&a.isOpen()&&(w=setTimeout(C,t))})})}function I(){var t=g.node;return t?a.transaction("rw","_syncNodes","_changes","_intercomm",function(){var n=!1;a._syncNodes.where("lastHeartBeat").below(Date.now()-o).filter(function(e){return"local"===e.type}).modify(function(e){e.deleteTimeStamp&&e.deleteTimeStamp<Date.now()?(delete this.value,s&&s.removeItem("Dexie.Observable/deadnode:"+e.id+"/"+a.name),e.isMaster&&(a._syncNodes.update(t,{isMaster:1}),n=!0),a._intercomm.where({destinationNode:e.id}).modify(function(e){e.wantReply?e.destinationNode=t.id:delete this.value})):e.deleteTimeStamp||(e.deleteTimeStamp=Date.now()+i)}).then(function(){return L.deleteOldChanges(a),a.on("cleanup").fire(n)})}):V.reject(new B.DatabaseClosedError)}function M(){g.node&&(A=!0,g.node.deleteTimeStamp=1,g.node.lastHeartBeat=0,a._syncNodes.put(g.node),L.wereTheOneDying=!0,s&&s.setItem("Dexie.Observable/deadnode:"+g.node.id.toString()+"/"+a.name,"dead"))}function j(e,n){e!==a.name||L.wereTheOneDying||B.vip(function(){a._syncNodes.update(n,{deleteTimeStamp:1,lastHeartBeat:0}).then(I)})}}L.latestRevision={},L.on=B.Events(null,"latestRevisionIncremented","suicideNurseCall","intercomm","beforeunload"),L.createUUID=c,L.deleteOldChanges=function n(t){B.ignoreTransaction(function(){return t._syncNodes.orderBy("myRevision").first(function(e){return t._changes.where("rev").below(e.myRevision).limit(100).primaryKeys()}).then(function(e){if(0!==e.length)return t._changes.bulkDelete(e).then(function(){100===e.length&&setTimeout(function(){return t.isOpen()&&n(t)},500)})})}).catch(function(){})},L._onStorage=(a=L,function(e){if(0===e.key.indexOf("Dexie.Observable/")){var n=e.key.split("/"),t=n[1],o=n[2];if("latestRevision"===t){var i=parseInt(e.newValue,10);!isNaN(i)&&i>a.latestRevision[o]&&(a.latestRevision[o]=i,B.ignoreTransaction(function(){a.on("latestRevisionIncremented").fire(o,i)}))}else if(0===t.indexOf("deadnode:")){var r=parseInt(t.split(":")[1],10);e.newValue&&a.on.suicideNurseCall.fire(o,r)}else"intercomm"===t&&e.newValue&&a.on.intercomm.fire(o)}}),L._onBeforeUnload=function(){L.on.beforeunload.fire()};try{L.localStorageImpl=W.localStorage}catch(e){}return W.addEventListener&&(W.addEventListener("storage",L._onStorage),W.addEventListener("beforeunload",L._onBeforeUnload)),B.Observable=L,B.addons.push(L),L});