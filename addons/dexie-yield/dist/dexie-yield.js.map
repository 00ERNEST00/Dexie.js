{"version":3,"file":"dexie-yield.js","sources":["../c:/repos/dexie/addons/dexie-yield/src/dexie-yield.js"],"sourcesContent":["ï»¿\nimport Dexie from 'dexie';\n\n// Prefer standard promise, but fallback to Dexie Promise.\n// The standard Promise will only be used in case the async function throws or returns value before yielding a thenable.\n// If writing the async functions correctly, async() will adapt to the type of promise returned, such as Q, WinJS or Dexie.\n\nvar Promise = (typeof self === 'undefined' ? global : (self || window)).Promise || Dexie.Promise; \n\nexport function async(generatorFn) {\n    return function () {\n        try {\n            var rv = iterate(generatorFn.apply(this, arguments));\n            if (!rv || typeof rv.then !== 'function')\n                return Promise.resolve(rv);\n            return rv;\n        } catch (e) {\n            return Promise.reject(e);\n        }\n    }\n}\n\nexport function spawn(generatorFn, args, thiz) {\n    try {\n        var rv = iterate(generatorFn.apply(thiz, args || []));\n        if (!rv || typeof rv.then !== 'function')\n            return Dexie.Promise.resolve(rv);\n        return rv;\n    } catch (e) {\n        return Dexie.Promise.reject(e);\n    }\n}\n\nexport function iterate (iterable) {\n    var callNext = result => iterable.next(result),\n        doThrow = error => iterable.throw(error),\n        onSuccess = step(callNext),\n        onError = step(doThrow);\n\n    function step(getNext) {\n        return val => {\n            var next = getNext(val),\n                value = next.value;\n\n            return next.done ? value :\n                (!value || typeof value.then !== 'function' ?\n                    Array.isArray(value) ? awaitAll(value, 0) : onSuccess(value) :\n                    value.then(onSuccess, onError));\n        }\n    }\n\n    function awaitAll (values, i) {\n        if (i === values.length) return onSuccess(values);\n        var value = values[i];\n        return value.constructor && typeof value.constructor.all == 'function' ?\n            value.constructor.all(values).then(onSuccess, onError) :\n            awaitAll (values, i + 1);\n    }\n\n    return step(callNext)();\n}\n\nDexie.addons.push(function (db) {\n    //\n    // Adjust db.transaction() to handle iterable functions as async without explicitely having to write async() around the transaction scope func:\n    //  db.transaction('rw', db.friends, async(function*(){})); - not needed.\n    //  db.transaction('rw', db.friends, function*(){}); // prettier.\n    //\n    db.transaction = Dexie.override(db.transaction, function (origDbTransaction) {\n        return function () {\n            var scopeFunc = arguments[arguments.length - 1];\n\n            function proxyScope() {\n                var rv = scopeFunc.apply(this, arguments);\n                if (!rv.next || !rv.throw) return rv; // Not an iterable\n                return iterate(rv);\n            }\n\n            proxyScope.toString =\n                () => scopeFunc.toString(); // Because original db.transaction may use fn.toString() when error occur.\n                \n            arguments[arguments.length - 1] = proxyScope;\n            return origDbTransaction.apply(this, arguments);\n        }\n    });\n});\n"],"names":[],"mappings":"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"}