(function(e,t,n,r){"use strict";function i(e,t){if(typeof t!=="object")t=t();Object.keys(t).forEach(function(n){e[n]=t[n]})}function s(e){return{from:function(t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;return{extend:function(n){i(e.prototype,typeof n==="function"?n(t.prototype):n)}}}}}function o(e,t){return function(){t.apply(e,arguments)}}function u(t){function I(){if(n)B.on("versionchange",function(t){if(t.newVersion&&t.newVersion>C){B.close();e.location.reload(true)}})}function q(e){this._cfg={version:e,dbschema:null,schemaUpgrade:null,contentUpgrade:null}}function R(e,t,n){if(e==0){Object.keys(N).forEach(function(e){W(t,e,N[e].primKey,N[e].indexes)});var r=new K(P,L,N);r.idbtrans=t;r.active=true;r.idbtrans.onerror=ct(n,["populating database"]);B.on("populate").fire(r)}else{var i=[];N=null;var s=k.filter(function(t){return t._cfg.version>e});s.forEach(function(e){var r=N;var s=e._cfg.dbschema;N=s;if(!r){i.push(function(e,t){Object.keys(s).forEach(function(t){W(e,t,s[t].primKey,s[t].indexes)});t()})}else{var u=U(r,s);u.add.forEach(function(e){i.push(function(t,n){W(t,e[0],e[1].primKey,e[1].indexes)});cb()});u.change.forEach(function(e){if(e.recreate){if(ht()){if(!H||!H[e.name]){H=H||{__num:0};++H.__num;H[e.name]=[];it(t.objectStore(e.name).openCursor(),null,function(t){H[e.name].push(t)},function(){if(--H.__num==0){t.abort();B.open()}})}}i.push(function(t,n){V(t,e.name,e.def.primKey,e.def.indexes,n)})}else{i.push(function(t,n){var r=t.objectStore(e.name);e.add.forEach(function(e){X(r,e)});e.change.forEach(function(e){r.deleteIndex(e.name);X(r,e)});e.del.forEach(function(e){r.deleteIndex(e)});n()})}});if(s._cfg.contentUpgrade){i.push(function(t,r){var i=new K(P,[].slice.call(t.db.objectStoreNames,0),s);i.idbtrans=t;i.active=true;var u=0;i._promise=o(function(e,t,n){function s(e){return function(){e.apply(this,arguments);if(--u==0)r()}}++u;return this.call(i,function(e,n,r){arguments[0]=s(e);arguments[1]=s(n);t.apply(this,arguments)});return this.apply(i,arguments).finally(function(){if(--u===0)r()})},i._promise);t.onerror=ct(n,["running upgrader function for version",e._cfg.version]);s._cfg.contentUpgrade(i);if(u===0)r()})}if(u.del.length){if(!ht()){i.push(function(e,t){u.del.forEach(function(t){e.db.deleteObjectStore(t)});t()})}}}});var u=function(){if(i.length)i.shift()(t,u)};if(H&&H.__num>0)return;u()}}function U(e,t){var n={del:[],add:[],change:[]};for(var r in e){if(!t[r])n.del.push(r)}for(var r in t){var i=e[r],s=t[r];if(!i)n.add.push([r,s]);else{var o={name:r,def:t[r],recreate:false,del:[],add:[],change:[]};if(i.primKey.src!=s.primKey.src){o.recreate=true;n.change.push(o)}else{var u=i.indexes.reduce(function(e,t){e[t.name]=t;return e},{});var a=s.indexes.reduce(function(e,t){e[t.name]=t;return e},{});for(var f in u){if(!a[f])o.del.push(f)}for(var f in a){var l=u[f],c=a[f];if(!l)o.add.push(c);else if(l.src!=c.src)o.change.push(c)}if(o.recreate||o.del.length>0||o.add.length>0||o.change.length>0){n.change.push(o)}}}}return n}function z(e,t,n){it(e.openCursor(),null,function(e){t.add(e)},n)}function W(e,t,n,r){var i=e.db.createObjectStore(t,{keyPath:n.keyPath,autoIncrement:n.auto});r.forEach(function(e){X(i,e)});return i}function X(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function V(e,t,n,r,i){if(H){var s=W(e,t,n,r);H[t].forEach(function(e){s.add(e)});delete H[t];if(Object.keys(H).length==0)H=null;i()}else{var o=W(e,"_temp-"+t,n,[]);z(e.objectStore(t),o,function(){e.db.deleteObjectStore(t);var s=W(e,t,n,r);z(o,s,function(){e.db.deleteObjectStore("_temp-"+t);i()})})}}function $(e,t,n,r){this.name=e;this.schema=n;this._tpf=t;this._collClass=r||G}function J(e,t,n,r){$.call(this,e,t,n,r||Y)}function K(e,t,n){var r=this;this.mode=e;this.storeNames=t;this.idbtrans=null;this.on=f(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._pls=null;this.active=false;this._dbschema=n;this._tpf=function(t,n,i,s){return r._promise(t,i,s)}}function Q(e,t,n){this._ctx={table:e,index:t===":id"?null:t,collClass:e._collClass,or:n}}function G(e,t){var n=e._ctx;this._ctx={table:n.table,index:n.index,range:t,op:"openCursor",dir:"next",unique:"",algorithm:null,filter:null,offset:0,limit:Infinity,error:null,or:n.or}}function Y(){G.apply(this,arguments)}function Z(e,t){return e._cfg.version-t._cfg.version}function et(){return k.sort(Z).reduce(function(e,t){return t._cfg.dbschema?t:e})._cfg.dbschema}function tt(e,t,n,r,i,s){n.forEach(function(n){if(!e[n]){var o=B._tableFactory(r,i[n],t);if(s){Object.defineProperty(e,n,{configurable:true,enumerable:true,get:function(){if(a.PLS&&a.PLS.prohibitDB){throw new T("Calling db."+n+" directly is not allowed in db.transaction() blocks.");return{ALL_TABLES_PROHIBITED_IN_TRANSCATION_SCOPE:1}}return o}})}else{e[n]=o}}})}function nt(e){e.forEach(function(e){for(var t in e){if(e[t]instanceof $)delete e[t]}})}function rt(e){var t=setTimeout(e,1e3);clearTimeout(t)}function it(e,t,n,r,i,s){if(!e.onerror)e.onerror=ct(i);if(s){var o=s.prototype;var u=n;if(F){n=function(e,t,n){if(e)e.__proto__=o;u(e,t,n)}}else{n=function(e,t,n){if(e){var r=Object.create(o);for(var i in e)r[i]=e[i];u(r,t)}else u(e,t,n)}}}if(t){e.onsuccess=h(function(o){var u=e.result;if(u){var a=function(){u.continue()};if(t(u,function(e){a=e},r,i))n(u.value,u,function(e){a=e});a()}else{r()}},i)}else{e.onsuccess=h(function(i){var s=e.result;if(s){var o=function(){s.continue()};n(s.value,s,function(e){o=e});o()}else{r()}},i)}}function st(e){var t=[];e.split(",").forEach(function(e){if(!e)return;var n=e.replace("&","").replace("++","").replace("*","");var r=n.indexOf("[")!==0?n:e.substring(1,e.indexOf("]")).split("+");t.push(new m(n,r||null,e.indexOf("&")!=-1,e.indexOf("*")!=-1,e.indexOf("++")!=-1,Array.isArray(r),r.indexOf(".")!=-1))});return t}function ot(e,t){return e<t?-1:e>t?1:0}function ut(e,t){return e<t?1:e>t?-1:0}function at(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}function ft(){}function lt(e){return function(t){return e(t&&t.target&&t.target.error)}}function ct(e,t){return function(n){var r=n&&n.target.error||{toString:""},i=r;if(t){i=Object.create(r);i.toString=function(){return r.toString()+" occurred when "+t.map(function(e){switch(typeof e){case"function":return e();case"string":return e;default:return JSON.stringify(e)}}).join(" ")}}var s=e(i);if(s){n.stopPropagation();n.preventDefault();return false}}}function ht(){return navigator.userAgent.indexOf("Trident / 7.0; rv: 11.0")>=0||navigator.userAgent.indexOf("MSIE")>=0}var r=u.dependencies;var l=r.indexedDB,p=r.IDBKeyRange,w=r.IDBTransaction;var E=r.DOMError,S=r.TypeError,x=r.RangeError,T=r.Error;var N=null;var C=0;var k=[];var L=[];var A={};var O=null;var M=null;var _=false;var D="readonly",P="readwrite";var H;var B=this;var j=[];var F=function(){function e(){}var t=new e;try{t.__proto__=Object.prototype;return!(t instanceof e)}catch(n){return false}}();this.version=function(e){if(O)throw new T("Cannot add version when database is open");C=Math.max(C,e);var t=k.filter(function(t){return t._cfg.version==e})[0];if(t)return t;t=new q(e);k.push(t);return t};i(q.prototype,{stores:function(e){var t=this._cfg.dbschema=this._cfg.dbschema||{};this._parseStoresSpec(e,t);var n=et();if(N!=n){N=n;nt([A,B]);tt(A,B._transPromiseFactory,Object.keys(n),P,n);tt(B,B._transPromiseFactory,Object.keys(n),P,n,true)}L=Object.keys(n);return this},upgrade:function(e){var t=this;rt(function(){e(new K(P,Object.keys(t._cfg.dbschema),t._cfg.dbschema))});this._cfg.contentUpgrade=e;return this},_parseStoresSpec:function(e,t){Object.keys(e).forEach(function(n){var r={};var i=st(e[n]);var s=i.shift();if(s.multi)throw new T("Primary key cannot be multi-valued");if(s.keyPath&&s.auto)d(r,s.keyPath,0);i.forEach(function(e){if(e.auto)throw new T("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new T("Index must have a name and cannot be an empty string");d(r,e.keyPath,e.compound?e.keyPath.map(function(){return""}):"")});t[n]=new g(n,s,i,r)})}});this._allTables=A;this._backendDB=function(){return O};this._tableFactory=function(t,n,r){if(t===D)return new $(n.name,r,n,G);else return new J(n.name,r,n)};this._transPromiseFactory=function(t,n,r){if(!O&&!M){return new a(function(e,i){j.push({resume:function(){B._transPromiseFactory(t,n,r).then(e,i)}})})}else{var i=new K(t,n,N);return i._promise(t,function(e,t){r(function(t){i.complete(function(){e(t)})},t,i)})}};this._whenReady=function(e){if(!O&&!M){return new a(function(t,n){rt(function(){new a(function(){e(t,n)})});j.push({resume:function(){new a(function(){e(t,n)})}})})}return new a(e)},this.open=function(){return new a(function(e,n){function r(e){_=false;M=e;n(M);j.forEach(function(e){e.resume()})}if(O)throw new T("Database already open");try{M=null;_=true;if(k.length==0)throw new T("No versions specified. Need to call version(ver) method");if(!k[0]._cfg.dbschema)throw new T("No schema specified. Need to call dbInstance.version(ver).stores(schema) on at least the lowest version.");k.sort(Z).reduce(function(e,t){if(!t._cfg.dbschema)t._cfg.dbschema=e._cfg.dbschema;return t});if(!l)throw new T("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");var i=l.open(t,C*10);i.onerror=lt(r);i.onblocked=B.on("blocked").fire;i.onupgradeneeded=function(e){i.transaction.onerror=lt(n);R(e.oldVersion/10,i.transaction,n)};i.onsuccess=function(e){_=false;O=i.result;O.onversionchange=B.on("versionchange").fire;j.forEach(function(e){e.resume()});j=[]}}catch(s){r(s)}})};this.close=function(){if(O){O.close();O=null;M=null}};this.delete=function(){return new a(function(e,n){function r(){B.close();var r=l.deleteDatabase(t);r.onsuccess=e;r.onerror=ct(n,["deleting",t]);r.onblocked=B.on("blocked").fire}if(_){j.push({resume:r})}else{r()}})};this.on=f(this,"error","populate","blocked","versionchange");rt(function(){B.on("populate").fire(new K(P,L,N));B.on("error").fire(new T)});this.transaction=function(e,t,n){t=[].slice.call(arguments,1,arguments.length-1);n=arguments[arguments.length-1];return B._whenReady(function(r,i){var s=a.pls();try{a.PLS.prohibitDB=true;var o=Array.isArray(t[0])?t.reduce(function(e,t){return e.concat(t)}):t;var u=o.map(function(e){if(typeof e=="string"){if(!N[e]){throw new T("Invalid table name: "+e);return{INVALID_TABLE_NAME:1}}return e}else{if(!(e instanceof $)){throw new S("Invalid type. Arguments following mode must be instances of Table or String");return{IVALID_TYPE:1}}return e.name}});if(e=="r"||e==D)e=D;else if(e=="rw"||e==P)e=P;else throw new x("Invalid transaction mode");var f=new K(e,u,N);var l=u.map(function(e){return f.table(e)});l.push(f);f.complete(r);f.error(function(e){var t=i(e);if(!t)B.on("error").fire(e)});try{n.apply(null,l)}catch(h){f.abort();c(function(){if(!i(h))B.on("error").fire(h)})}}finally{a.PLS=s}})};this.table=function(e){if(!A.hasOwnProperty(e)){throw new T("Table does not exist");return{AN_UNKNOWN_TABLE_NAME_WAS_SPECIFIED:1}}return A[e]};i($.prototype,function(){function e(n){if(typeof n=="function"){return new n}else if(Array.isArray(n)){return[e(n[0])]}else if(typeof n=="object"){var r={};t(r,n);return r}else{return n}}function t(t,n){Object.keys(n).forEach(function(r){var i=e(n[r]);t[r]=i})}return{_trans:function(t,n,r){return this._tpf(t,[this.name],n,r)},_idbstore:function(t,n,r){var i=this;return this._tpf(t,[this.name],function(e,t,r){n(e,t,r.idbtrans.objectStore(i.name))},r)},get:function(e,t){var n=this;rt(function(){t(n.schema.instanceTemplate)});return this._idbstore(D,function(t,r,i){var s=i.get(e);s.onerror=ct(r,["getting",e,"from",n.name]);s.onsuccess=function(){var e=n.schema.mappedClass;if(e){var r=s.result;if(!r){t(r)}else if(F){r.__proto__=e.prototype;t(r)}else{var i=Object.create(e.prototype);for(var o in r)i[o]=r[o];t(i)}}else{t(s.result)}}}).then(t)},where:function(e){return new Q(this,e)},count:function(e){return(new this._collClass(new Q(this))).count(e)},limit:function(e){return(new this._collClass(new Q(this))).limit(e)},each:function(e){var t=this;rt(function(){e(t.schema.instanceTemplate)});return this._idbstore(D,function(n,r,i){var s=i.openCursor();s.onerror=ct(r,["calling","Table.each()","on",t.name]);it(s,null,e,n,r,t.schema.mappedClass)})},toArray:function(e){var t=this;rt(function(){e([t.schema.instanceTemplate])});return this._idbstore(D,function(e,n,r){var i=[];var s=r.openCursor();s.onerror=ct(n,["calling","Table.toArray()","on",t.name]);it(s,null,function(e){i.push(e)},function(){e(i)},n,t.schema.mappedClass)}).then(e)},orderBy:function(e){return new this._collClass(new Q(this,e))},mapToClass:function(e,n){var r=this.schema.mappedClass=e;var i=Object.create(r.prototype);if(n){t(i,n)}this.schema.instanceTemplate=i;return e},defineClass:function(e){var n={};t(n,e);var r={};t(r,e);if(this.schema.primKey.keyPath)v(r,this.schema.primKey.keyPath);var s=this.schema.mappedClass=function(e){if(e){i(this,e)}};Object.defineProperty(r,"constructor",{configurable:true,value:s,writable:true});s.prototype=r;this.schema.instanceTemplate=n;return s}}});s(J).from($).extend(function(){return{put:function(e,t){var n=this;return this._idbstore(P,function(r,i,s){var o=t?s.put(e,t):s.put(e);o.onerror=ct(i,["putting",e,"into",n.name]);o.onsuccess=function(t){var n=s.keyPath;if(n)d(e,n,t.target.result);r(o.result)}})},add:function(e,t){var n=this;return this._idbstore(P,function(r,i,s){var o=t?s.add(e,t):s.add(e);o.onerror=ct(i,["adding",e,"into",n.name]);o.onsuccess=function(t){var n=s.keyPath;if(n)d(e,n,t.target.result);r(o.result)}})},"delete":function(e){return this._idbstore(P,function(t,n,r){var i=r.delete(e);i.onerror=ct(n,["deleting",e,"from",r.name]);i.onsuccess=function(e){t(i.result)}})},clear:function(){return this._idbstore(P,function(e,t,n){var r=n.clear();r.onerror=ct(t,["clearing",n.name]);r.onsuccess=function(t){e(r.result)}})},modify:function(e){return(new this._collClass(new Q(this))).modify(e)},update:function(e,t){return this.where(":id").equals(e).modify(t)}}});i(K.prototype,{_lock:function(){++this._reculock;if(this._reculock===1)this._pls=a.PLS&&a.PLS.constructor;return this},_unlock:function(){if(--this._reculock===0){this._pls=null;while(this._blockedFuncs.length>0&&!this._locked()){var e=this._blockedFuncs.shift();try{e()}catch(t){}}}return this},_locked:function(){return this._reculock&&(!this._pls||!(a.PLS instanceof this._pls))},_promise:function(e,t,n){var r=this;if(!this._locked()){var i=new a(function(i,s){if(!r.idbtrans&&e){if(!O)throw M;var o=r.idbtrans=O.transaction(r.storeNames,r.mode);r.active=true;o.onerror=function(e){r.on("error").fire(e&&e.target.error);e.preventDefault();r.abort()};o.onabort=function(e){r.active=false;r.on("abort").fire(e)};o.oncomplete=function(e){r.active=false;r.on("complete").fire(e)}}if(n)r._lock();t(i,s,r)});if(n)i.finally(function(){r._unlock()});i.onuncatched=function(e){r.on("error").fire(e);r.abort()};return i}else{return new a(function(i,s){r._blockedFuncs.push(function(){r._promise(e,t,n).then(i,s)})})}},complete:function(e){return this.on("complete",e)},error:function(e){return this.on("error",e)},abort:function(){if(this.idbtrans&&this.active)try{this.active=false;this.idbtrans.abort()}catch(e){}},table:function(e){if(!this._dbschema.hasOwnProperty(e)){throw new T("Table does not exist");return{AN_UNKNOWN_TABLE_NAME_WAS_SPECIFIED:1}}return B._tableFactory(this.mode,this._dbschema[e],this._tpf)}});i(Q.prototype,function(){function e(e,t){try{throw t}catch(n){e._ctx.error=n}return e}function t(e){return Array.prototype.slice.call(Array.isArray(e[0])?e[0]:e,0).sort()}function n(e){return e==="next"?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}function r(e){return e==="next"?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}function i(e,t,n,r,i,s){var o=Math.min(e.length,r.length);var u=-1;for(var a=0;a<o;++a){var f=t[a];if(f!==r[a]){if(i(e[a],n[a])<0)return e.substr(0,a)+n[a]+n.substr(a+1);if(i(e[a],r[a])<0)return e.substr(0,a)+r[a]+n.substr(a+1);if(u>=0)return e.substr(0,u)+t[u]+n.substr(u+1);return null}if(i(e[a],f)<0)u=a}if(o<r.length&&s==="next")return e+n.substr(e.length);if(o<e.length&&s==="prev")return e.substr(0,n.length);return u<0?null:e.substr(0,u)+r[u]+n.substr(u+1)}function s(e,t,s){function h(e){o=n(e);u=r(e);a=e==="next"?ot:ut;f=o(s);l=u(s);c=e}var o,u,a,f,l,c;h("next");e._ondirectionchange=function(e){h(e)};e._addAlgorithm(function(e,n,r){var s=e.key;if(typeof s!=="string")return false;var o=u(s);if(t(o,l)){n(function(){e.continue()});return true}else{var h=i(s,o,f,l,a,c);if(h){n(function(){e.continue(h)})}else{n(r)}return false}})}return{between:function(e,t,n,r){n=n!==false;r=r===true;if(e>t||e==t&&(n||r)&&!(n&&r))return(new this._ctx.collClass(this,p.only(e))).limit(0);return new this._ctx.collClass(this,p.bound(e,t,!n,!r))},equals:function(e){return new this._ctx.collClass(this,p.only(e))},above:function(e){return new this._ctx.collClass(this,p.lowerBound(e,true))},aboveOrEqual:function(e){return new this._ctx.collClass(this,p.lowerBound(e))},below:function(e){return new this._ctx.collClass(this,p.upperBound(e,true))},belowOrEqual:function(e){return new this._ctx.collClass(this,p.upperBound(e))},startsWith:function(t){if(typeof t!="string")return e(new G(this),new S("String expected"));return this.between(t,t+String.fromCharCode(65535),true,true)},startsWithIgnoreCase:function(t){if(typeof t!="string")return e(new G(this),new S("String expected"));if(t==="")return this.startsWith(t);var n=new this._ctx.collClass(this);s(n,function(e,t){return e.indexOf(t)===0},t);n._ondirectionchange=function(){e(n,new T("desc() not supported with WhereClause.startsWithIgnoreCase()"))};return n},equalsIgnoreCase:function(t){if(typeof t!="string")return e(new G(this),new S("String expected"));var n=new this._ctx.collClass(this);s(n,function(e,t){return e===t},t);return n},anyOf:function(e){var n=t(arguments);var r=new this._ctx.collClass(this);var i=ot;r._ondirectionchange=function(e){i=e==="next"?ot:ut;n.sort(i)};var s=0;r._addAlgorithm(function(e,t,r){var o=e.key;while(i(o,n[s])>0){++s;if(s===n.length){t(r);return false}}if(o===n[s]){t(function(){e.continue()});return true}else{t(function(){e.continue(n[s])});return false}});return r}}});i(G.prototype,function(){function e(e,t){e.filter=at(e.filter,t)}function t(e,t){var n=e.index;return!n||t.keyPath&&n===t.keyPath?t:t.index(n)}function n(e,n){return t(e,n)[e.op](e.range||null,e.dir+e.unique)}function r(e,t,r,i,s){var o=e.table.schema.mappedClass;if(!e.or){it(n(e,s),at(e.algorithm,e.filter),t,r,i,o)}else{(function(){function c(){if(++l===2)r()}function h(e,n,r){if(!u||u(n,r,c,i)){var s=JSON.stringify(n.primaryKey);if(!a.hasOwnProperty(s)){a[s]=true;t(e,n,r)}}}var u=e.filter;var a={};var f=e.table.schema.primKey.keyPath;var l=0;e.or._iterate(h,c,i,s);it(n(e,s),e.algorithm,h,c,i,o)})()}}function i(e){return e.table.schema.instanceTemplate}return{_read:function(e,t){var n=this._ctx;if(n.error)return n.table._trans(null,function(t,r){r(n.error)});else return n.table._idbstore(D,e).then(t)},_write:function(e){var t=this._ctx;if(t.error)return t.table._trans(null,function(n,r){r(t.error)});else return t.table._idbstore(P,e,"locked")},_addAlgorithm:function(e){var t=this._ctx;t.algorithm=at(t.algorithm,e)},_iterate:function(e,t,n,i){return r(this._ctx,e,t,n,i)},each:function(e){var t=this._ctx;rt(function(){e(i(t))});return this._read(function(n,i,s){r(t,e,n,i,s)})},count:function(e){rt(function(){e(0)});var n=this,i=this._ctx;if(i.filter||i.algorithm||i.or){var s=0;return this._read(function(e,t,n){r(i,function(){++s;return false},function(){e(s)},t,n)},e)}else{return this._read(function(e,r,s){var o=t(i,s);var u=i.range?o.count(i.range):o.count();u.onerror=ct(r,["calling","count()","on",n.name]);u.onsuccess=function(t){e(Math.min(t.target.result,Math.max(0,i.limit-i.offset)))}},e)}},sortBy:function(e,t){function u(e,t){if(t)return u(e[r[t]],t-1);return e[s]}function f(e,t){var n=u(e,o),r=u(t,o);return n<r?-a:n>r?a:0}var n=this._ctx;rt(function(){t([i(n)])});var r=e.split(".").reverse(),s=r[0],o=r.length-1;var a=this._ctx.dir==="next"?1:-1;return this.toArray(function(e){return e.sort(f)}).then(t)},toArray:function(e){var t=this._ctx;rt(function(){e([i(t)])});return this._read(function(e,n,i){var s=[];r(t,function(e){s.push(e)},function(){e(s)},n,i)},e)},offset:function(t){var n=this._ctx;if(t<=0)return this;n.offset+=t;if(!n.or&&!n.algorithm&&!n.filter){e(n,function(n,r,i){if(t===0)return true;if(t===1){--t;return false}r(function(){n.advance(t);t=0});return false})}else{e(n,function(n,r,i){return--t<0})}return this},limit:function(t){this._ctx.limit=Math.min(this._ctx.limit,t);e(this._ctx,function(e,n,r){if(--t<=0)n(r);return t>=0});return this},first:function(e){var t=this;rt(function(){e(i(t._ctx))});return this.limit(1).toArray(function(e){return e[0]}).then(e)},last:function(e){return this.desc().first(e)},and:function(t){var n=this;rt(function(){t(i(n._ctx))});e(this._ctx,function(e){return t(e.value)});return this},or:function(e){return new Q(this._ctx.table,e,this)},desc:function(){this._ctx.dir=this._ctx.dir=="prev"?"next":"prev";if(this._ondirectionchange)this._ondirectionchange(this._ctx.dir);return this},eachKey:function(e){var t=this;rt(function(){e(i(t._ctx)[t._ctx.index])});this._ctx.op="openKeyCursor";return this.each(function(t,n){e(n.key,n)})},eachUniqueKey:function(e){this._ctx.unique="unique";return this.eachKey(e)},keys:function(e){rt(function(){e([i(n)[t._ctx.index]])});var t=this,n=this._ctx;this._ctx.op="openKeyCursor";var r=[];return this.each(function(e,t){r.push(t.key)}).then(function(){return r}).then(e)},uniqueKeys:function(e){this._ctx.unique="unique";return this.keys(e)},distinct:function(){var t={};e(this._ctx,function(e){var n=JSON.stringify(e.primaryKey);var r=t.hasOwnProperty(n);t[n]=true;return!r});return this}}});s(Y).from(G).extend({modify:function(e){var t=this,n=this._ctx;return this._write(function(r,i,s){function p(e,t,r){var i={value:e};o.call(i,e);var s=t.update(i.value);++f;s.onerror=ct(function(e){h.push(e);return true},function(){return["modifying",e,"on",n.table.name]});s.onsuccess=function(){++l;m()}}function v(e){if(e)h.push(e);return i(new b("Error modifying one or more objects",h,l))}function m(){if(c&&l+h.length===f){if(h.length>0)v();else r(l)}}var o;if(typeof e==="function"){o=e}else{var u=Object.keys(e);var a=u.length;o=function(t){for(var n=0;n<a;++n){var r=u[n];d(t,r,e[r])}}}var f=0;var l=0;var c=false;var h=[];t._iterate(p,function(){c=true;m()},v,s)})},"delete":function(){var e=this,t=this._ctx;return this._write(function(n,r,i){function l(e,n,r){var i=[n.primaryKey,e];var u=n.delete();s.push(i);u.onerror=ct(function(e){a.push(e);f.push(i);s.splice(s.indexOf(i),1);return true},function(){return["deleting",e,"on",t.table.name]});u.onsuccess=function(){++o;h()}}function c(e){if(e)a.push(e);r(new y("Error deleting one or more objects",a,s))}function h(){if(u&&o+a.length===s.length){if(a.length>0)c();else n(s)}}var s=[];var o=0;var u=false;var a=[];var f=[];e._iterate(l,function(){u=true;if(o===s.length){n(s)}},c,i)})}});i(this,{Collection:G,Promise:a,Table:$,Transaction:K,Version:q,WhereClause:Q,WriteableCollection:Y,WriteableTable:J});I();u.addons.forEach(function(e){e(B)})}function f(e,t){function i(e){function t(){for(var e=this.l.length-1;e>=0;--e){if(this.l[e].apply(this,arguments)===false)return false}}r[e]={l:[],f:t,s:function(e){this.l.push(e)},u:function(e){this.l=this.l.filter(function(t){return t!==e})}};return t}function s(e,t){var n=i(e);var s=i(t);var o=new a(function(n,i){r[e].f=n;r[t].f=i});r[e].p=o;o.then(function(t){n.call(r[e],t)},function(e){s.call(r[t],e)})}var n=arguments;var r={};for(var o=1,u=n.length;o<u;++o){var f=n[o];if(typeof f=="string"){i(f)}else{s(f[0],f[1])}}var l=function(t,n){if(n){r[t].s(n);return e}else if(typeof t==="string"){return{fire:function(){r[t].f.apply(r[t],arguments)},unsubscribe:function(e){r[t].u(e)}}}else{var i=t[0],s=t[1];return{getPromise:function(){return r[i].p}}}};return l}function l(e){if(!e)throw new Error("Assertion failed")}function c(t){if(e.setImmediate)setImmediate(t);else setTimeout(t,0)}function h(e,t){return function(){try{e.apply(this,arguments)}catch(n){t(n)}}}function p(e,t){if(!t)return e;if(Array.isArray(t)){var n=[];for(var i=0,s=t.length;i<s;++i){var o=p(e,t[i]);if(o===r)return;n.push(o)}return o}var u=t.indexOf(".");if(u!=-1){var a=e[t.substr(0,u)];return a===r?r:p(a,t.substr(u+1))}return e.hasOwnProperty(t)?e[t]:r}function d(e,t,n){if(!e||t===r)return;var i=arguments[3];if(Array.isArray(t)){l(Array.isArray(n));for(var s=0,o=t.length;s<o;++s){d(e,t[s],n[s])}}else{var u=t.indexOf(".");if(u!==-1){var a=t.substr(0,u);var f=t.substr(u+1);if(f==="")if(i)delete e[a];else e[a]=n;else{var c=e[a];if(!c)c=e[a]={};d(c,f,n,i)}}else{if(i)delete e[t];else e[t]=n}}}function v(e,t){d(e,t,null,true)}function m(e,t,n,r,i,s,o){this.name=e;this.keyPath=t;this.unique=n;this.multi=r;this.auto=i;this.compound=s;this.dotted=o;this.src=(n?"&":"")+(r?"*":"")+(i?"++":"")+t}function g(e,t,n,r){this.name=e;this.primKey=t||new m;this.indexes=n||[new m];this.instanceTemplate=r;this.mappedClass=null}function y(e,t,n){Error.call(this,e);this.name="MultiDeleteError";this.failures=t;this.deletedRecords=n}function b(e,t,n){Error.call(this,e);this.name="MultiModifyError";this.failures=t;this.successCount=n}var a=function(){function t(n){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");if(typeof n!=="function")throw new TypeError("not a function");this._state=null;this._value=null;this._deferreds=[];this._catched=false;var r=this;var o=true;var u=t.pls();this._PLS=t.PLS;try{a(this,n,function(t){if(o)e(i,r,t);else i(r,t)},function(t){if(o){e(s,r,t);return false}else{return s(r,t)}})}finally{o=false;t.PLS=u}}function n(e){var t=this;if(this._state===null){this._deferreds.push(e);return}var n=t._state?e.onFulfilled:e.onRejected;if(n===null){return(t._state?e.resolve:e.reject)(t._value)}var i;try{i=n(t._value);if(!t._state&&(!i||typeof i.then!=="function"))r(t)}catch(s){var o=e.reject(s);if(!o&&t.onuncatched){try{t.onuncatched(s)}catch(s){}}return}e.resolve(i)}function r(e){e._catched=true;if(e._parent)r(e._parent)}function i(e,n){var r=t.PLS;t.PLS=e._PLS;try{if(n===e)throw new TypeError("A promise cannot be resolved with itself.");if(n&&(typeof n==="object"||typeof n==="function")){if(typeof n.then==="function"){a(e,function(e,t){n.then(e,t)},function(t){i(e,t)},function(t){s(e,t)});return}}e._state=true;e._value=n;o.call(e)}catch(u){s(u)}finally{t.PLS=r}}function s(e,n){var r=t.PLS;t.PLS=e._PLS;e._state=false;e._value=n;o.call(e);if(!e._catched&&e.onuncatched){try{e.onuncatched(e._value)}catch(i){}}t.PLS=r;return e._catched}function o(){for(var e=0,t=this._deferreds.length;e<t;e++){n.call(this,this._deferreds[e])}this._deferreds=null}function u(e,t,n,r){this.onFulfilled=typeof e==="function"?e:null;this.onRejected=typeof t==="function"?t:null;this.resolve=n;this.reject=r}function a(e,t,n,r){var i=false;try{t(function(t){if(i)return;i=true;n(t)},function(n){if(i)return e._catched;i=true;return r(n)})}catch(s){if(i)return;return r(s)}}var e=typeof setImmediate==="undefined"?function(e,t,n,r){var i=arguments;setTimeout(function(){e.apply(this,[].slice.call(i,1))},0)}:function(e,t,n,r){setImmediate.apply(this,arguments)};t.all=function(){var e=Array.prototype.slice.call(arguments.length===1&&Array.isArray(arguments[0])?arguments[0]:arguments);return new t(function(t,n){function i(s,o){try{if(o&&(typeof o==="object"||typeof o==="function")){var u=o.then;if(typeof u==="function"){u.call(o,function(e){i(s,e)},n);return}}e[s]=o;if(--r===0){t(e)}}catch(a){n(a)}}if(e.length===0)return t([]);var r=e.length;for(var s=0;s<e.length;s++){i(s,e[s])}})};t.prototype.then=function(e,r){var i=this;var s=new t(function(t,s){n.call(i,new u(e,r,t,s))});s._PLS=this._PLS;s.onuncatched=this.onuncatched;s._parent=this;return s};t.prototype["catch"]=function(e){if(arguments.length===1)return this.then(null,e);var n=arguments[0],r=arguments[1];return this.then(null,function(e){if(e instanceof n)return r(e);else return t.reject(e)})};t.prototype["finally"]=function(e){this.then(function(t){e()},function(e){return t.reject(e)});return this};t.prototype.onuncatched=null;t.resolve=function(e){var n=new t(function(){});n._state=true;n._value=e};t.reject=function(e){var n=new t(function(){});n._state=false;n._value=e;return n};t.race=function(e){return new t(function(t,n){e.map(function(e){e.then(t,n)})})};t.PLS=null;t.pls=function(){function n(){}var e=t.PLS;if(e)n.prototype=e;t.PLS=new n;t.PLS.constructor=n;return e};return t}();s(y).from(Error);s(b).from(Error);u.delete=function(e){var t=new u(e),n=t.delete();n.onblocked=function(e){t.on("blocked",e);return this};return n};u.MultiDeleteError=y;u.MultiModifyError=b;u.IndexSpec=m;u.TableSchema=g;u.Promise=a;u.derive=s;u.extend=i;u.override=o;u.events=f;u.getByKeyPath=p;u.setByKeyPath=d;u.delByKeyPath=v;u.addons=[];u.dependencies={indexedDB:e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB,IDBKeyRange:e.IDBKeyRange||e.webkitIDBKeyRange,IDBTransaction:e.IDBTransaction||e.webkitIDBTransaction,Error:e.Error||String,SyntaxError:e.SyntaxError||String,TypeError:e.TypeError||String,RangeError:e.RangeError||String,DOMError:e.DOMError||String};u.version=.96;t("Dexie",u)}).apply(this,typeof module==="undefined"||typeof window!=="undefined"&&this==window?[window,function(e,t){window[e]=t},true]:[global,function(e,t){module.exports=t},false])