(function(e,t,n,r){"use strict";function i(e,t){if(typeof t!=="object")t=t();Object.keys(t).forEach(function(n){e[n]=t[n]});return e}function s(e){return{from:function(t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;return{extend:function(n){i(e.prototype,typeof n!=="object"?n(t.prototype):n)}}}}}function o(e,t){return t(e)}function u(t){function Z(){if(n)Q.on("versionchange",function(t){if(t.newVersion&&t.newVersion>I){Q.close();e.location.reload(true)}})}function et(e){this._cfg={version:e,dbschema:null,schemaUpgrade:null,contentUpgrade:null}}function tt(e,t,n){if(e==0){Object.keys(F).forEach(function(e){it(t,e,F[e].primKey,F[e].indexes)});var r=Q._createTransaction(J,R,F);r.idbtrans=t;r.active=true;r.idbtrans.onerror=Tt(n,["populating database"]);Q.on("populate").fire(r)}else{var i=[];F=Q._dbSchema=null;var s=q.filter(function(t){return t._cfg.version>e});s.forEach(function(e){var r=F;var s=e._cfg.dbschema;F=Q._dbSchema=s;if(!r){i.push(function(e,t){st(s,e);t()})}else{var u=nt(r,s);u.add.forEach(function(e){i.push(function(t,n){it(t,e[0],e[1].primKey,e[1].indexes)});cb()});u.change.forEach(function(e){if(e.recreate){if(Nt()){if(!K||!K[e.name]){K=K||{__num:0};++K.__num;K[e.name]=[];yt(t.objectStore(e.name).openCursor(),null,function(t){K[e.name].push(t)},function(){if(--K.__num==0){t.abort();Q.open()}})}}i.push(function(t,n){ut(t,e.name,e.def.primKey,e.def.indexes,n)})}else{i.push(function(t,n){var r=t.objectStore(e.name);e.add.forEach(function(e){ot(r,e)});e.change.forEach(function(e){r.deleteIndex(e.name);ot(r,e)});e.del.forEach(function(e){r.deleteIndex(e)});n()})}});if(s._cfg.contentUpgrade){i.push(function(t,r){var i=Q._createTransaction(J,[].slice.call(t.db.objectStoreNames,0),s);i.idbtrans=t;i.active=true;var u=0;i._promise=o(i._promise,function(e){return function(t,n,i){function s(e){return function(){e.apply(this,arguments);if(--u==0)r()}}++u;return e.call(this,t,function(e,t,r){arguments[0]=s(e);arguments[1]=s(t);n.apply(this,arguments)},i)}});t.onerror=Tt(n,["running upgrader function for version",e._cfg.version]);s._cfg.contentUpgrade(i);if(u===0)r()})}if(u.del.length){if(!Nt()){i.push(function(e,t){u.del.forEach(function(t){e.db.deleteObjectStore(t)});t()})}}}});var u=function(){if(i.length)i.shift()(t,u);else st(F,t)};if(K&&K.__num>0)return;u()}}function nt(e,t){var n={del:[],add:[],change:[]};for(var r in e){if(!t[r])n.del.push(r)}for(var r in t){var i=e[r],s=t[r];if(!i)n.add.push([r,s]);else{var o={name:r,def:t[r],recreate:false,del:[],add:[],change:[]};if(i.primKey.src!=s.primKey.src){o.recreate=true;n.change.push(o)}else{var u=i.indexes.reduce(function(e,t){e[t.name]=t;return e},{});var a=s.indexes.reduce(function(e,t){e[t.name]=t;return e},{});for(var f in u){if(!a[f])o.del.push(f)}for(var f in a){var l=u[f],c=a[f];if(!l)o.add.push(c);else if(l.src!=c.src)o.change.push(c)}if(o.recreate||o.del.length>0||o.add.length>0||o.change.length>0){n.change.push(o)}}}}return n}function rt(e,t,n){yt(e.openCursor(),null,function(e){t.add(e)},n)}function it(e,t,n,r){var i=e.db.createObjectStore(t,{keyPath:n.keyPath,autoIncrement:n.auto});r.forEach(function(e){ot(i,e)});return i}function st(e,t){Object.keys(e).forEach(function(n){if(!t.db.objectStoreNames.contains(n)){it(t,n,e[n].primKey,e[n].indexes)}})}function ot(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function ut(e,t,n,r,i){if(K){var s=it(e,t,n,r);K[t].forEach(function(e){s.add(e)});delete K[t];if(Object.keys(K).length==0)K=null;i()}else{var o=it(e,"_temp-"+t,n,[]);rt(e.objectStore(t),o,function(){e.db.deleteObjectStore(t);var s=it(e,t,n,r);rt(o,s,function(){e.db.deleteObjectStore("_temp-"+t);i()})})}}function at(e,t,n,r){this.name=e;this.schema=n;this.hook=U[e]?U[e].hook:y(null,{creating:[p,f],reading:[c,l],updating:[d,f],deleting:[m,f]});this._tpf=t;this._collClass=r||ht}function ft(e,t,n,r){at.call(this,e,t,n,r||pt)}function lt(e,t,n){function i(e,t,n,i){return r._promise(e,n,i)}var r=this;this.mode=e;this.storeNames=t;this.idbtrans=null;this.on=y(this,["complete","error"],"abort");this._reculock=0;this._blockedFuncs=[];this._psd=null;this.active=false;this._dbschema=n;this._tpf=i;this.tables={};for(var s=t.length-1;s!==-1;--s){var o=t[s];var u=Q._tableFactory(e,n[o],i);this.tables[o]=u;if(!this[o])this[o]=u}}function ct(e,t,n){this._ctx={table:e,index:t===":id"?null:t,collClass:e._collClass,or:n}}function ht(e,t){var n=e._ctx;this._ctx={table:n.table,index:n.index,range:t,op:"openCursor",dir:"next",unique:"",algorithm:null,filter:null,isMatch:null,offset:0,limit:Infinity,error:null,or:n.or}}function pt(){ht.apply(this,arguments)}function dt(e,t){return e._cfg.version-t._cfg.version}function vt(){return q.sort(dt).reduce(function(e,t){return t._cfg.dbschema?t:e})._cfg.dbschema}function mt(e,t,n,r,i,s){n.forEach(function(n){if(!e[n]){var o=Q._tableFactory(r,i[n],t);if(s){Object.defineProperty(e,n,{configurable:true,enumerable:true,get:function(){if(a.PSD&&a.PSD.prohibitDB){throw new j("Dont call db."+n+" directly. Use tables from db.transaction() instead.");return{ALL_TABLES_PROHIBITED_IN_TRANSCATION_SCOPE:1}}return o}})}else{e[n]=o}}})}function gt(e){e.forEach(function(e){for(var t in e){if(e[t]instanceof at)delete e[t]}})}function yt(e,t,n,r,i,s){s=s||l;if(!e.onerror)e.onerror=Tt(i);if(t){e.onsuccess=S(function(u){var a=e.result;if(a){var f=function(){a.continue()};if(t(a,function(e){f=e},r,i))n(s(a.value),a,function(e){f=e});f()}else{r()}},i)}else{e.onsuccess=S(function(i){var o=e.result;if(o){var u=function(){o.continue()};n(s(o.value),o,function(e){u=e});u()}else{r()}},i)}}function bt(e){var t=[];e.split(",").forEach(function(e){if(!e)return;var n=e.replace("&","").replace("++","").replace("*","");var r=n.indexOf("[")!==0?n:e.substring(1,e.indexOf("]")).split("+");t.push(new M(n,r||null,e.indexOf("&")!=-1,e.indexOf("*")!=-1,e.indexOf("++")!=-1,Array.isArray(r),r.indexOf(".")!=-1))});return t}function wt(e,t){return e<t?-1:e>t?1:0}function Et(e,t){return e<t?1:e>t?-1:0}function St(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}function xt(e){return function(t){return e(t&&t.target&&t.target.error)}}function Tt(e,t){return function(n){var r=n&&n.target.error||{toString:""},i=r;if(t){i=Object.create(r);i.toString=function(){return r.toString()+" occurred when "+t.map(function(e){switch(typeof e){case"function":return e();case"string":return e;default:return JSON.stringify(e)}}).join(" ")}}var s=e(i);if(s){n.stopPropagation();n.preventDefault();return false}}}function Nt(){return navigator.userAgent.indexOf("Trident / 7.0; rv: 11.0")>=0||navigator.userAgent.indexOf("MSIE")>=0}var h=u.dependencies;var v=h.indexedDB,b=h.IDBKeyRange,A=h.IDBTransaction;var P=h.DOMError,H=h.TypeError,B=h.RangeError,j=h.Error;var F=this._dbSchema=null;var I=0;var q=[];var R=[];var U={};var z=null;var W=true;var X=null;var V=false;var $="readonly",J="readwrite";var K;var Q=this;var G=[];var Y=function(){function e(){}var t=new e;try{t.__proto__=Object.prototype;return!(t instanceof e)}catch(n){return false}}();this.version=function(e){if(z)throw new j("Cannot add version when database is open");I=Math.max(I,e);var t=q.filter(function(t){return t._cfg.version==e})[0];if(t)return t;t=new et(e);q.push(t);return t};i(et.prototype,{stores:function(e){var t=this._cfg.dbschema=this._cfg.dbschema||{};this._parseStoresSpec(e,t);var n=vt();if(F!=n){F=Q._dbSchema=n;gt([U,Q]);mt(U,Q._transPromiseFactory,Object.keys(n),J,n);mt(Q,Q._transPromiseFactory,Object.keys(n),J,n,true)}R=Object.keys(n);return this},upgrade:function(e){var t=this;E(function(){e(Q._createTransaction(J,Object.keys(t._cfg.dbschema),t._cfg.dbschema))});this._cfg.contentUpgrade=e;return this},_parseStoresSpec:function(e,t){Object.keys(e).forEach(function(n){var r={};var i=bt(e[n]);var s=i.shift();if(s.multi)throw new j("Primary key cannot be multi-valued");if(s.keyPath&&s.auto)T(r,s.keyPath,0);i.forEach(function(e){if(e.auto)throw new j("Only primary key can be marked as autoIncrement (++)");if(!e.keyPath)throw new j("Index must have a name and cannot be an empty string");T(r,e.keyPath,e.compound?e.keyPath.map(function(){return""}):"")});t[n]=new _(n,s,i,r)})}});this._allTables=U;this._tableFactory=function(t,n,r){if(t===$)return new at(n.name,r,n,ht);else return new ft(n.name,r,n)};this._createTransaction=function(e,t,n){return new lt(e,t,n)};this._transPromiseFactory=function(t,n,r){if(W&&(!a.PSD||!a.PSD.letThrough)){return new a(function(e,i){G.push({resume:function(){Q._transPromiseFactory(t,n,r).then(e,i)}})})}else{var i=Q._createTransaction(t,n,F);return i._promise(t,function(e,t){r(function(t){i.complete(function(){e(t)})},t,i)})}};this._whenReady=function(e){if(W&&(!a.PSD||!a.PSD.letThrough)){return new a(function(t,n){E(function(){new a(function(){e(t,n)})});G.push({resume:function(){new a(function(){e(t,n)})}})})}return new a(e)},this.open=function(){return new a(function(e,n){function r(e){V=false;X=e;W=false;n(X);G.forEach(function(e){e.resume()})}if(z||V)throw new j("Database already opened or being opened");try{X=null;V=true;if(q.length==0)throw new j("No versions specified. Need to call version(ver) method");if(!q[0]._cfg.dbschema)throw new j("No schema specified. Need to call dbInstance.version(ver).stores(schema) on at least the lowest version.");q.sort(dt).reduce(function(e,t){if(!t._cfg.dbschema)t._cfg.dbschema=e._cfg.dbschema;return t});if(!v)throw new j("indexedDB API not found. If using IE10+, make sure to run your code on a server URL (not locally). If using Safari, make sure to include indexedDB polyfill.");var i=v.open(t,I*10);i.onerror=xt(r);i.onblocked=Q.on("blocked").fire;i.onupgradeneeded=function(e){i.transaction.onerror=xt(r);tt(e.oldVersion/10,i.transaction,r)};i.onsuccess=function(t){function o(){W=false;G.forEach(function(e){e.resume()});G=[];e()}V=false;z=i.result;z.onversionchange=Q.on("versionchange").fire;var n=a.psd();a.PSD.letThrough=true;try{var s=Q.on.ready.fire();if(s&&typeof s.then=="function"){s.then(o,r)}else{w(o)}}catch(t){r(t)}finally{a.PSD=n}}}catch(s){r(s)}})};this.close=function(){if(z){z.close();z=null;W=true;X=null}};this.delete=function(){return new a(function(e,n){function r(){Q.close();var r=v.deleteDatabase(t);r.onsuccess=e;r.onerror=Tt(n,["deleting",t]);r.onblocked=function(){Q.on("blocked").fire()}}if(V){G.push({resume:r})}else{r()}})};this.backendDB=function(){return z};this.isOpen=function(){return z!==null};this.hasFailed=function(){return X!==null};this.name=t;this.on=y(this,"error","populate","blocked","versionchange",{ready:[g,f]});E(function(){Q.on("populate").fire(Q._createTransaction(J,R,F));Q.on("error").fire(new j)});this.transaction=function(e,t,n){t=[].slice.call(arguments,1,arguments.length-1);n=arguments[arguments.length-1];return Q._whenReady(function(r,i){var s=a.psd();try{a.PSD.prohibitDB=true;var o=Array.isArray(t[0])?t.reduce(function(e,t){return e.concat(t)}):t;var u=o.map(function(e){if(typeof e=="string"){if(!F[e]){throw new j("Invalid table name: "+e);return{INVALID_TABLE_NAME:1}}return e}else{if(!(e instanceof at)){throw new H("Invalid type. Arguments following mode must be instances of Table or String");return{IVALID_TYPE:1}}return e.name}});if(e=="r"||e==$)e=$;else if(e=="rw"||e==J)e=J;else throw new B("Invalid transaction mode");var f=Q._createTransaction(e,u,F);var l=u.map(function(e){return f.table(e)});l.push(f);f.complete(r);f.error(function(e){var t=i(e);if(!t)Q.on("error").fire(e)});try{n.apply(null,l)}catch(c){f.abort();w(function(){if(!i(c))Q.on("error").fire(c)})}}finally{a.PSD=s}})};this.table=function(e){if(!U.hasOwnProperty(e)){throw new j("Table does not exist");return{AN_UNKNOWN_TABLE_NAME_WAS_SPECIFIED:1}}return U[e]};i(at.prototype,function(){return{_trans:function(t,n,r){return this._tpf(t,[this.name],n,r)},_idbstore:function(t,n,r){var i=this;return this._tpf(t,[this.name],function(e,t,r){n(e,t,r.idbtrans.objectStore(i.name),r)},r)},get:function(e,t){var n=this;E(function(){t(n.schema.instanceTemplate)});return this._idbstore($,function(t,r,i){var s=i.get(e);s.onerror=Tt(r,["getting",e,"from",n.name]);s.onsuccess=function(){t(n.hook.reading.fire(s.result))}}).then(t)},where:function(e){return new ct(this,e)},count:function(e){return(new this._collClass(new ct(this))).count(e)},offset:function(e){return(new this._collClass(new ct(this))).offset(e)},limit:function(e){return(new this._collClass(new ct(this))).limit(e)},each:function(e){var t=this;E(function(){e(t.schema.instanceTemplate)});return this._idbstore($,function(n,r,i){var s=i.openCursor();s.onerror=Tt(r,["calling","Table.each()","on",t.name]);yt(s,null,e,n,r,t.hook.reading.fire)})},toArray:function(e){var t=this;E(function(){e([t.schema.instanceTemplate])});return this._idbstore($,function(e,n,r){var i=[];var s=r.openCursor();s.onerror=Tt(n,["calling","Table.toArray()","on",t.name]);yt(s,null,function(e){i.push(e)},function(){e(i)},n,t.hook.reading.fire)}).then(e)},orderBy:function(e){return new this._collClass(new ct(this,e))},toCollection:function(){return new this._collClass(new ct(this))},mapToClass:function(e,t){if(this.schema.mappedClass)throw new j("Table already mapped");t=t||C(e.prototype);if(this.schema.primKey.keyPath)N(e.prototype,this.schema.primKey.keyPath);this.schema.mappedClass=e;var n=Object.create(e.prototype);if(t){O(n,t)}this.schema.instanceTemplate=n;this.hook("reading",Y?function(n){if(!n)return n;n.__proto__=e.prototype;return n}:function(t){if(!t)return t;var n=Object.create(proto);for(var r in t)if(t.hasOwnProperty(r))n[r]=t[r];return n});return e},defineClass:function(e){return this.mapToClass(u.defineClass(e),e)}}});s(ft).from(at).extend(function(){return{add:function(e,t){var n=this,i=this.hook.creating.fire;return this._idbstore(J,function(s,o,u,a){var l={};if(i!==f){var c=t||u.keyPath&&x(e,u.keyPath);var h=i.call(l,c,e,a);if(c===r&&h!==r){if(u.keyPath)T(e,u.keyPath,h);else t=h}}var p=t?u.add(e,t):u.add(e);p.onerror=Tt(function(e){if(l.onerror)l.onerror(e);return o(e)},["adding",e,"into",n.name]);p.onsuccess=function(t){var n=u.keyPath;if(n)T(e,n,t.target.result);if(l.onsuccess)l.onsuccess(t.target.result);s(p.result)}})},put:function(e,t){var n=this;if(this.hook.creating.subscribers.length||this.hook.deleting.subscribers.length){return this._trans(J,function(i,s,o){t=t||n.schema.primKey.keyPath&&x(e,n.schema.primKey.keyPath);if(t===r){o.tables[n.name].add(e).then(i,s)}else{o._lock();e=k(e);o.tables[n.name].where(":id").equals(t).modify(function(t){this.value=e}).then(function(r){if(r===0){return o.tables[n.name].add(e,t)}else{return t}}).finally(function(){o._unlock()}).then(i,s)}})}else{return this._idbstore(J,function(r,i,s){var o=t?s.put(e,t):s.put(e);o.onerror=Tt(i,["putting",e,"into",n.name]);o.onsuccess=function(t){var n=s.keyPath;if(n)T(e,n,t.target.result);r(o.result)}})}},"delete":function(e){if(this.hook.deleting.subscribers.length){return this.where(":id").equals(e).delete()}else{return this._idbstore(J,function(t,n,r){var i=r.delete(e);i.onerror=Tt(n,["deleting",e,"from",r.name]);i.onsuccess=function(e){t(i.result)}})}},clear:function(){if(this.hook.deleting.subscribers.length){this.toCollection().delete()}else{return this._idbstore(J,function(e,t,n){var r=n.clear();r.onerror=Tt(t,["clearing",n.name]);r.onsuccess=function(t){e(r.result)}})}},update:function(e,t){return this.where(":id").equals(e).modify(t)}}});i(lt.prototype,{_lock:function(){++this._reculock;if(this._reculock===1)this._psd=a.PSD&&a.PSD.constructor;return this},_unlock:function(){if(--this._reculock===0){this._psd=null;while(this._blockedFuncs.length>0&&!this._locked()){var e=this._blockedFuncs.shift();try{e()}catch(t){}}}return this},_locked:function(){return this._reculock&&(!this._psd||!(a.PSD instanceof this._psd))},_promise:function(e,t,n){var r=this;if(!this._locked()){var i=new a(function(i,s){if(!r.idbtrans&&e){if(!z)throw X;var o=r.idbtrans=z.transaction(r.storeNames,r.mode);r.active=true;o.onerror=function(e){r.on("error").fire(e&&e.target.error);e.preventDefault();r.abort()};o.onabort=function(e){r.active=false;r.on("abort").fire(e)};o.oncomplete=function(e){r.active=false;r.on("complete").fire(e)}}if(n)r._lock();t(i,s,r)});if(n)i.finally(function(){r._unlock()});i.onuncatched=function(e){r.on("error").fire(e);r.abort()};return i}else{return new a(function(i,s){r._blockedFuncs.push(function(){r._promise(e,t,n).then(i,s)})})}},complete:function(e){return this.on("complete",e)},error:function(e){return this.on("error",e)},abort:function(){if(this.idbtrans&&this.active)try{this.active=false;this.idbtrans.abort()}catch(e){}},table:function(e){if(!this.tables.hasOwnProperty(e)){throw new j("Table does not exist");return{AN_UNKNOWN_TABLE_NAME_WAS_SPECIFIED:1}}return this.tables[e]}});i(ct.prototype,function(){function e(e,t){try{throw t}catch(n){e._ctx.error=n}return e}function t(e){return Array.prototype.slice.call(Array.isArray(e[0])?e[0]:e,0).sort()}function n(e){return e==="next"?function(e){return e.toUpperCase()}:function(e){return e.toLowerCase()}}function r(e){return e==="next"?function(e){return e.toLowerCase()}:function(e){return e.toUpperCase()}}function i(e,t,n,r,i,s){var o=Math.min(e.length,r.length);var u=-1;for(var a=0;a<o;++a){var f=t[a];if(f!==r[a]){if(i(e[a],n[a])<0)return e.substr(0,a)+n[a]+n.substr(a+1);if(i(e[a],r[a])<0)return e.substr(0,a)+r[a]+n.substr(a+1);if(u>=0)return e.substr(0,u)+t[u]+n.substr(u+1);return null}if(i(e[a],f)<0)u=a}if(o<r.length&&s==="next")return e+n.substr(e.length);if(o<e.length&&s==="prev")return e.substr(0,n.length);return u<0?null:e.substr(0,u)+r[u]+n.substr(u+1)}function s(e,t,s){function h(e){o=n(e);u=r(e);a=e==="next"?wt:Et;f=o(s);l=u(s);c=e}var o,u,a,f,l,c;h("next");e._ondirectionchange=function(e){h(e)};e._addAlgorithm(function(e,n,r){var s=e.key;if(typeof s!=="string")return false;var o=u(s);if(t(o,l)){n(function(){e.continue()});return true}else{var h=i(s,o,f,l,a,c);if(h){n(function(){e.continue(h)})}else{n(r)}return false}})}return{between:function(e,t,n,r){n=n!==false;r=r===true;if(e>t||e==t&&(n||r)&&!(n&&r))return(new this._ctx.collClass(this,b.only(e))).limit(0);return new this._ctx.collClass(this,b.bound(e,t,!n,!r))},equals:function(e){return new this._ctx.collClass(this,b.only(e))},above:function(e){return new this._ctx.collClass(this,b.lowerBound(e,true))},aboveOrEqual:function(e){return new this._ctx.collClass(this,b.lowerBound(e))},below:function(e){return new this._ctx.collClass(this,b.upperBound(e,true))},belowOrEqual:function(e){return new this._ctx.collClass(this,b.upperBound(e))},startsWith:function(t){if(typeof t!="string")return e(new ht(this),new H("String expected"));return this.between(t,t+String.fromCharCode(65535),true,true)},startsWithIgnoreCase:function(t){if(typeof t!="string")return e(new ht(this),new H("String expected"));if(t==="")return this.startsWith(t);var n=new this._ctx.collClass(this);s(n,function(e,t){return e.indexOf(t)===0},t);n._ondirectionchange=function(){e(n,new j("desc() not supported with WhereClause.startsWithIgnoreCase()"))};return n},equalsIgnoreCase:function(t){if(typeof t!="string")return e(new ht(this),new H("String expected"));var n=new this._ctx.collClass(this);s(n,function(e,t){return e===t},t);return n},anyOf:function(e){var n=t(arguments);var r=new this._ctx.collClass(this);var i=wt;r._ondirectionchange=function(e){i=e==="next"?wt:Et;n.sort(i)};var s=0;r._addAlgorithm(function(e,t,r){var o=e.key;while(i(o,n[s])>0){++s;if(s===n.length){t(r);return false}}if(o===n[s]){t(function(){e.continue()});return true}else{t(function(){e.continue(n[s])});return false}});return r}}});i(ht.prototype,function(){function e(e,t){e.filter=St(e.filter,t)}function t(e,t){e.isMatch=St(e.isMatch,t)}function n(e,t){var n=e.index;return!n||t.keyPath&&n===t.keyPath?t:t.index(n)}function r(e,t){return n(e,t)[e.op](e.range||null,e.dir+e.unique)}function i(e,t,n,i,s){if(!e.or){yt(r(e,s),St(e.algorithm,e.filter),t,n,i,e.table.hook.reading.fire)}else{(function(){function l(){if(++f===2)n()}function c(e,n,r){if(!o||o(n,r,l,i)){var s=JSON.stringify(n.primaryKey);if(!u.hasOwnProperty(s)){u[s]=true;t(e,n,r)}}}var o=e.filter;var u={};var a=e.table.schema.primKey.keyPath;var f=0;e.or._iterate(c,l,i,s);yt(r(e,s),e.algorithm,c,l,i,e.table.hook.reading.fire)})()}}function s(e){return e.table.schema.instanceTemplate}return{_read:function(e,t){var n=this._ctx;if(n.error)return n.table._trans(null,function(t,r){r(n.error)});else return n.table._idbstore($,e).then(t)},_write:function(e){var t=this._ctx;if(t.error)return t.table._trans(null,function(n,r){r(t.error)});else return t.table._idbstore(J,e,"locked")},_addAlgorithm:function(e){var t=this._ctx;t.algorithm=St(t.algorithm,e)},_iterate:function(e,t,n,r){return i(this._ctx,e,t,n,r)},each:function(e){var t=this._ctx;E(function(){e(s(t))});return this._read(function(n,r,s){i(t,e,n,r,s)})},count:function(e){E(function(){e(0)});var t=this,r=this._ctx;if(r.filter||r.algorithm||r.or){var s=0;return this._read(function(e,t,n){i(r,function(){++s;return false},function(){e(s)},t,n)},e)}else{return this._read(function(e,i,s){var o=n(r,s);var u=r.range?o.count(r.range):o.count();u.onerror=Tt(i,["calling","count()","on",t.name]);u.onsuccess=function(t){e(Math.min(t.target.result,Math.max(0,r.limit-r.offset)))}},e)}},sortBy:function(e,t){function u(e,t){if(t)return u(e[r[t]],t-1);return e[i]}function f(e,t){var n=u(e,o),r=u(t,o);return n<r?-a:n>r?a:0}var n=this._ctx;E(function(){t([s(n)])});var r=e.split(".").reverse(),i=r[0],o=r.length-1;var a=this._ctx.dir==="next"?1:-1;return this.toArray(function(e){return e.sort(f)}).then(t)},toArray:function(e){var t=this._ctx;E(function(){e([s(t)])});return this._read(function(e,n,r){var s=[];i(t,function(e){s.push(e)},function(){e(s)},n,r)},e)},offset:function(t){var n=this._ctx;if(t<=0)return this;n.offset+=t;if(!n.or&&!n.algorithm&&!n.filter){e(n,function(n,r,i){if(t===0)return true;if(t===1){--t;return false}r(function(){n.advance(t);t=0});return false})}else{e(n,function(n,r,i){return--t<0})}return this},limit:function(t){this._ctx.limit=Math.min(this._ctx.limit,t);e(this._ctx,function(e,n,r){if(--t<=0)n(r);return t>=0});return this},first:function(e){var t=this;E(function(){e(s(t._ctx))});return this.limit(1).toArray(function(e){return e[0]}).then(e)},last:function(e){return this.desc().first(e)},and:function(n){var r=this;E(function(){n(s(r._ctx))});e(this._ctx,function(e){return n(e.value)});t(this._ctx,n);return this},or:function(e){return new ct(this._ctx.table,e,this)},desc:function(){this._ctx.dir=this._ctx.dir=="prev"?"next":"prev";if(this._ondirectionchange)this._ondirectionchange(this._ctx.dir);return this},eachKey:function(e){var t=this;E(function(){e(s(t._ctx)[t._ctx.index])});this._ctx.op="openKeyCursor";return this.each(function(t,n){e(n.key,n)})},eachUniqueKey:function(e){this._ctx.unique="unique";return this.eachKey(e)},keys:function(e){E(function(){e([s(n)[t._ctx.index]])});var t=this,n=this._ctx;this._ctx.op="openKeyCursor";var r=[];return this.each(function(e,t){r.push(t.key)}).then(function(){return r}).then(e)},uniqueKeys:function(e){this._ctx.unique="unique";return this.keys(e)},distinct:function(){var t={};e(this._ctx,function(e){var n=JSON.stringify(e.primaryKey);var r=t.hasOwnProperty(n);t[n]=true;return!r});return this}}});s(pt).from(ht).extend({modify:function(e){var t=this,n=this._ctx,s=n.table.hook,o=s.updating.fire,u=s.deleting.fire;E(function(){if(typeof e==="function"){e.call({value:n.table.schema.instanceTemplate},n.table.schema.instanceTemplate)}});return this._write(function(s,a,l,c){function w(e,t,r){var i={primKey:t.primaryKey,value:e};h.call(i,e);var s=!i.hasOwnProperty("value");var o=s?t.delete():t.update(i.value);++m;o.onerror=Tt(function(e){b.push(e);if(i.onerror)i.onerror(e);return true},function(){return s?["deleting",e,"from",n.table.name]:["modifying",e,"on",n.table.name]});o.onsuccess=function(e){if(i.onsuccess)i.onsuccess(i.value);++g;S()}}function E(e){if(e)b.push(e);return a(new D("Error modifying one or more objects",b,g))}function S(){if(y&&g+b.length===m){if(b.length>0)E();else s(g)}}var h;if(typeof e==="function"){if(o===f&&u===f){h=e}else{h=function(t){var n=k(t);e.call(this,t);if(!this.hasOwnProperty("value")){u.call(this,this.primKey,t,c)}else{var i=L(n,this.value);var s=o.call(this,i,this.primKey,n,c);if(s){t=this.value;Object.keys(s).forEach(function(e){if(s[e]===r)N(t,e);else T(t,e,s[e])})}}}}}else if(o===f){var p=Object.keys(e);var d=p.length;h=function(t){for(var n=0;n<d;++n){var i=p[n],s=e[i];if(s===r)N(t,i);else T(t,i,s)}}}else{var v=e;e=C(v);h=function(t){var n=o.call(this,e,this.primKey,k(t),c);if(n)i(e,n);Object.keys(e).forEach(function(n){if(e[n]===r)N(t,n,e[n]);else T(t,n,e[n])});if(n)e=C(v)}}var m=0;var g=0;var y=false;var b=[];t._iterate(w,function(){y=true;S()},E,l)})},"delete":function(){return this.modify(function(){delete this.value})}});i(this,{Collection:ht,Table:at,Transaction:lt,Version:et,WhereClause:ct,WriteableCollection:pt,WriteableTable:ft});Z();u.addons.forEach(function(e){e(Q)})}function f(){}function l(e){return e}function c(e,t){if(e===l)return t;return function(n){return t(e(n))}}function h(e,t){return function(){e.apply(this,arguments);t.apply(this,arguments)}}function p(e,t){if(e===f)return t;return function(){var n=e.apply(this,arguments);if(n!==r)arguments[0]=n;var i=this.onsuccess,s=this.onerror;delete this.onsuccess;delete this.onerror;var o=t.apply(this,arguments);if(i)this.onsuccess=this.onsuccess?h(i,this.onsuccess):i;if(s)this.onerror=this.onerror?h(s,this.onerror):s;return o!==r?o:n}}function d(e,t){if(e===f)return t;return function(){var n=e.apply(this,arguments);if(n!==r)i(arguments[0],n);var s=this.onsuccess,o=this.onerror;delete this.onsuccess;delete this.onerror;var u=t.apply(this,arguments);if(s)this.onsuccess=this.onsuccess?h(s,this.onsuccess):s;if(o)this.onerror=this.onerror?h(o,this.onerror):o;return n===r?u===r?r:u:n.extend(u)}}function v(e,t){if(e===f)return t;return function(){if(e.apply(this,arguments)===false)return false;return t.apply(this,arguments)}}function m(e,t){if(e===f)return t;return function(){e.apply(this,arguments);t.apply(this,arguments)}}function g(e,t){if(e===f)return t;return function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){var r=this,i=arguments;return n.then(function(){return t.apply(r,i)})}return t.apply(this,arguments)}}function y(e,t){function s(e,t,n){if(Array.isArray(e))return u(e);if(typeof e==="object")return o(e);if(!t)t=v;if(!n)n=f;var i={subscribers:[],fire:n,subscribe:function(e){i.subscribers.push(e);i.fire=t(i.fire,e)},unsubscribe:function(e){i.subscribers=i.subscribers.filter(function(t){return t!==e});i.fire=i.subscribers.reduce(t,n)}};r[e]=i;return i}function o(e){Object.keys(e).forEach(function(t){s(t,e[t][0],e[t][1])})}function u(e){function n(){if(t)return false;t=true}var t=false;e.forEach(function(e){s(e).subscribe(n)})}var n=arguments;var r={};for(var a=1,l=n.length;a<l;++a){s(n[a])}var c=function(t,n){if(n){r[t].subscribe(n);return e}else if(typeof t==="string"){return r[t]}};i(c,r);c.addEventType=s;return c}function b(e){if(!e)throw new Error("Assertion failed")}function w(t){if(e.setImmediate)setImmediate(t);else setTimeout(t,0)}function E(e){var t=setTimeout(e,1e3);clearTimeout(t)}function S(e,t){return function(){try{e.apply(this,arguments)}catch(n){t(n)}}}function x(e,t){if(e.hasOwnProperty(t))return e[t];if(!t)return e;if(typeof t!=="string"){var n=[];for(var i=0,s=t.length;i<s;++i){var o=x(e,t[i]);if(o===r)return;n.push(o)}return o}var u=t.indexOf(".");if(u!==-1){var a=e[t.substr(0,u)];return a===r?r:x(a,t.substr(u+1))}return r}function T(e,t,n){if(!e||t===r)return;var i=arguments[3];if(Array.isArray(t)){b(Array.isArray(n));for(var s=0,o=t.length;s<o;++s){T(e,t[s],n[s])}}else{var u=t.indexOf(".");if(u!==-1){var a=t.substr(0,u);var f=t.substr(u+1);if(f==="")if(i)delete e[a];else e[a]=n;else{var l=e[a];if(!l)l=e[a]={};T(l,f,n,i)}}else{if(i)delete e[t];else e[t]=n}}}function N(e,t){T(e,t,null,true)}function C(e){var t={};for(var n in e){if(e.hasOwnProperty(n))t[n]=e[n]}return t}function k(e){if(!e||typeof e!=="object")return e;var t;if(Array.isArray(e)){t=[];for(var n=0,r=e.length;n<r;++n){t.push(k(e[n]))}}else if(e instanceof Date){t=new Date;t.setTime(e.getTime())}else{t=e.constructor?Object.create(e.constructor.prototype):{};for(var i in e){if(e.hasOwnProperty(i)){t[i]=k(e[i])}}}return t}function L(e,t){var n={};for(var i in e)if(e.hasOwnProperty(i)){if(!t.hasOwnProperty(i))n[i]=r;else if(e[i]!==t[i])n[i]=t[i]}for(var i in t)if(t.hasOwnProperty(i)&&!e.hasOwnProperty(i)){n[i]=t[i]}return n}function A(e){if(typeof e=="function"){return new e}else if(Array.isArray(e)){return[A(e[0])]}else if(e&&typeof e=="object"){var t={};O(t,e);return t}else{return e}}function O(e,t){Object.keys(t).forEach(function(n){var r=A(t[n]);e[n]=r})}function M(e,t,n,r,i,s,o){this.name=e;this.keyPath=t;this.unique=n;this.multi=r;this.auto=i;this.compound=s;this.dotted=o;this.src=(n?"&":"")+(r?"*":"")+(i?"++":"")+t}function _(e,t,n,r){this.name=e;this.primKey=t||new M;this.indexes=n||[new M];this.instanceTemplate=r;this.mappedClass=null}function D(e,t,n){Error.call(this,e);this.name="MultiModifyError";this.failures=t;this.successCount=n}var a=function(){function t(n){if(typeof this!=="object")throw new TypeError("Promises must be constructed via new");if(typeof n!=="function")throw new TypeError("not a function");this._state=null;this._value=null;this._deferreds=[];this._catched=false;var r=this;var o=true;var u=t.psd();this._PSD=t.PSD;try{a(this,n,function(t){if(o)e(i,r,t);else i(r,t)},function(t){if(o){e(s,r,t);return false}else{return s(r,t)}})}finally{o=false;t.PSD=u}}function n(e){var t=this;if(this._state===null){this._deferreds.push(e);return}var n=t._state?e.onFulfilled:e.onRejected;if(n===null){return(t._state?e.resolve:e.reject)(t._value)}var i;try{i=n(t._value);if(!t._state&&(!i||typeof i.then!=="function"))r(t)}catch(s){var o=e.reject(s);if(!o&&t.onuncatched){try{t.onuncatched(s)}catch(s){}}return}e.resolve(i)}function r(e){e._catched=true;if(e._parent)r(e._parent)}function i(e,n){var r=t.PSD;t.PSD=e._PSD;try{if(n===e)throw new TypeError("A promise cannot be resolved with itself.");if(n&&(typeof n==="object"||typeof n==="function")){if(typeof n.then==="function"){a(e,function(e,t){n.then(e,t)},function(t){i(e,t)},function(t){s(e,t)});return}}e._state=true;e._value=n;o.call(e)}catch(u){s(u)}finally{t.PSD=r}}function s(e,n){var r=t.PSD;t.PSD=e._PSD;e._state=false;e._value=n;o.call(e);if(!e._catched&&e.onuncatched){try{e.onuncatched(e._value)}catch(i){}}t.PSD=r;return e._catched}function o(){for(var e=0,t=this._deferreds.length;e<t;e++){n.call(this,this._deferreds[e])}this._deferreds=null}function u(e,t,n,r){this.onFulfilled=typeof e==="function"?e:null;this.onRejected=typeof t==="function"?t:null;this.resolve=n;this.reject=r}function a(e,t,n,r){var i=false;try{t(function(t){if(i)return;i=true;n(t)},function(n){if(i)return e._catched;i=true;return r(n)})}catch(s){if(i)return;return r(s)}}var e=typeof setImmediate==="undefined"?function(e,t,n,r){var i=arguments;setTimeout(function(){e.apply(this,[].slice.call(i,1))},0)}:function(e,t,n,r){setImmediate.apply(this,arguments)};t.all=function(){var e=Array.prototype.slice.call(arguments.length===1&&Array.isArray(arguments[0])?arguments[0]:arguments);return new t(function(t,n){function i(s,o){try{if(o&&(typeof o==="object"||typeof o==="function")){var u=o.then;if(typeof u==="function"){u.call(o,function(e){i(s,e)},n);return}}e[s]=o;if(--r===0){t(e)}}catch(a){n(a)}}if(e.length===0)return t([]);var r=e.length;for(var s=0;s<e.length;s++){i(s,e[s])}})};t.prototype.then=function(e,r){var i=this;var s=new t(function(t,s){n.call(i,new u(e,r,t,s))});s._PSD=this._PSD;s.onuncatched=this.onuncatched;s._parent=this;return s};t.prototype["catch"]=function(e){if(arguments.length===1)return this.then(null,e);var n=arguments[0],r=arguments[1];return this.then(null,function(e){if(e instanceof n)return r(e);else return t.reject(e)})};t.prototype["finally"]=function(e){return this.then(function(t){e();return t},function(e){return t.reject(e)})};t.prototype.onuncatched=null;t.resolve=function(e){var n=new t(function(){});n._state=true;n._value=e};t.reject=function(e){var n=new t(function(){});n._state=false;n._value=e;return n};t.race=function(e){return new t(function(t,n){e.map(function(e){e.then(t,n)})})};t.PSD=null;t.psd=function(){function n(){}var e=t.PSD;if(e)n.prototype=e;t.PSD=new n;t.PSD.constructor=n;return e};return t}();s(D).from(Error);u.delete=function(e){var t=new u(e),n=t.delete();n.onblocked=function(e){t.on("blocked",e);return this};return n};u.defineClass=function(e){function t(e){if(e)i(this,e)}O(t.prototype,e);return t};u.Promise=a;u.derive=s;u.extend=i;u.override=o;u.events=y;u.getByKeyPath=x;u.setByKeyPath=T;u.delByKeyPath=N;u.shallowClone=C;u.deepClone=k;u.addons=[];u.fakeAutoComplete=E;u.MultiModifyError=D;u.IndexSpec=M;u.TableSchema=_;u.dependencies={indexedDB:e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB,IDBKeyRange:e.IDBKeyRange||e.webkitIDBKeyRange,IDBTransaction:e.IDBTransaction||e.webkitIDBTransaction,Error:e.Error||String,SyntaxError:e.SyntaxError||String,TypeError:e.TypeError||String,RangeError:e.RangeError||String,DOMError:e.DOMError||String};u.version=.97;t("Dexie",u)}).apply(this,typeof module==="undefined"||typeof window!=="undefined"&&this==window?[window,function(e,t){window[e]=t},true]:[global,function(e,t){module.exports=t},false])